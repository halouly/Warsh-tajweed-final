<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsh Reader Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#92400e">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- TAJWEED COLORS (defaults, overridden by dynamic CSS) --- */
        .tj-ghunnah   { color: #16a34a !important; } 
        .tj-qalqalah  { color: #0284c7 !important; } 
        .tj-heavy     { color: #1e3a8a !important; font-weight: bold; } 
        .tj-ra-heavy  { color: #1e3a8a !important; font-weight: bold; } 
        .tj-ra-light  { color: #06b6d4 !important; } 
        .tj-madd      { color: #dc2626 !important; } 
        .tj-silent    { color: #9ca3af !important; } 
        .tj-special   { color: #d97706 !important; font-weight: bold; }

        /* --- THEMES & UI --- */
        :root { 
            --bg: #fffcf2; --text: #1a1a1a; --accent: #92400e; --panel: #ffffff; --border: #e5e5e5;
            --active-bg: #fef3c7; --active-border: #92400e;
            --sz: 32px; --lh: 2.8; --ws: normal; --max-w: 800px;
        }
        body.dark {
            --bg: #1f2937; --text: #f3f4f6; --accent: #fbbf24; --panel: #111827; --border: #374151;
            --active-bg: #374151; --active-border: #fbbf24;
        }

        body { font-family: 'Amiri', serif; background: var(--bg); color: var(--text); margin:0; padding-bottom:180px; transition: 0.3s; }
        header { position: sticky; top: 0; z-index: 900; background: var(--panel); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin:0; font-size: 1.2rem; color: var(--accent); }
        .tools { display: flex; gap: 8px; }
        .popover { display: none; position: absolute; top: 60px; right: 20px; background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 8px; z-index: 950; min-width: 300px; max-height: 500px; overflow-y: auto; }
        .popover.show { display: block; }
        html[dir="rtl"] .popover { right: auto; left: 20px; }
        .pop-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; }
        #display { padding: 40px 20px; max-width: var(--max-w); margin: 0 auto; line-height: var(--lh); word-spacing: var(--ws); text-align: justify; }
        .verse { display: inline; font-size: var(--sz); padding: 4px 0; border-bottom: 1px dashed var(--border); transition: 0.2s; position: relative; }
        .verse.active { background: var(--active-bg); box-shadow: 0 0 0 3px var(--active-bg); border-radius: 6px; }
        .num { font-size: 0.5em; color: var(--accent); border: 1px solid var(--accent); border-radius: 50%; padding: 0 6px; margin: 0 6px; vertical-align: middle; display: inline-block; }
        .bm-icon { font-size: 0.6em; margin-left: 5px; color: #ccc; cursor: pointer; }
        .bm-icon.saved { color: #f59e0b; }
        #controls { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel); border-top: 2px solid var(--accent); padding: 15px; z-index: 1000; direction: ltr; }
        .row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        select, input, button { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; }
        button.primary { background: var(--accent); color: #fff; border: none; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; color: var(--text); }
        .big-btn { font-size: 1.5rem; padding: 0 15px; line-height: 1; }
        .page-nav.hidden { display: none; }
        #custom-chunk-input { width: 50px; display: none; text-align: center; }
        #custom-chunk-input.show { display: inline-block; }
        .typo-row { margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        
        /* Dev Mode Styles */
        .dev-badge { background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .dev-badge.active { background: #22c55e; }
        .dev-banner { background: rgba(139, 92, 246, 0.1); border-bottom: 1px solid rgba(139, 92, 246, 0.3); padding: 8px; text-align: center; font-size: 0.85rem; }
        .letter-unit:hover { outline: 2px solid #8b5cf6; outline-offset: 1px; }
        
        /* Dev Panel Modal */
        .modal-overlay { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-overlay.show { display: flex; align-items: center; justify-content: center; }
        .modal { background: var(--panel); border-radius: 12px; max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .modal-tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .modal-tab.active { border-bottom-color: var(--accent); color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .rule-card { border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .rule-card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .color-preview { width: 40px; height: 40px; border-radius: 6px; border: 1px solid var(--border); }
        .color-input { width: 60px; height: 40px; cursor: pointer; }
        
        /* Letter Editor Popup */
        .letter-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border-radius: 12px; padding: 20px; z-index: 3000; min-width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .letter-popup.show { display: block; }
        .letter-preview { font-size: 4rem; text-align: center; margin: 15px 0; }
        
        /* Override List */
        .override-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--border); }
        .override-letter { font-size: 1.5rem; min-width: 40px; }
    </style>
</head>
<body>
    <header>
        <div class="tools">
            <button class="icon-btn" onclick="togglePanel('search-panel')" title="Search">üîç</button>
            <button class="icon-btn" onclick="togglePanel('bm-panel')" title="Bookmarks">‚òÖ</button>
            <button class="icon-btn" onclick="togglePanel('typo-panel')" title="Text Settings">T</button>
            <button class="icon-btn" onclick="toggleTheme()" title="Theme">üåó</button>
            <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">‚õ∂</button>
        </div>
        <h1 id="surah-title">Warsh Reader</h1>
        <div class="tools">
            <span id="dev-badge" class="dev-badge" onclick="toggleDevMode()">Dev Mode</span>
            <button class="icon-btn" id="dev-panel-btn" style="display:none" onclick="openDevPanel()">üé®</button>
        </div>
    </header>

    <!-- Dev Mode Banner -->
    <div id="dev-banner" class="dev-banner" style="display:none">
        üé® Dev Mode Active - Click on any letter to change its color
        <span id="override-count"></span>
    </div>

    <div id="search-panel" class="popover">
        <h3 style="margin-top:0">Search</h3>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="search-input" placeholder="Type word..." style="flex:1">
            <button onclick="runGlobalSearch()">Go</button>
        </div>
        <div id="search-status" style="font-size:0.8rem; color:#666; margin-bottom:5px;"></div>
        <div id="search-results" style="max-height:300px; overflow-y:auto;"></div>
    </div>
    <div id="bm-panel" class="popover"><h3 style="margin-top:0">Bookmarks</h3><div id="bm-list">No bookmarks yet.</div></div>
    <div id="typo-panel" class="popover">
        <div class="typo-row"><span class="typo-label">Text Size</span><input type="range" min="20" max="70" value="32" oninput="updateSetting('sz', this.value+'px')"></div>
        <div class="typo-row"><span class="typo-label">Line Height</span><input type="range" min="1.5" max="4.0" step="0.1" value="2.8" oninput="updateSetting('lh', this.value)"></div>
        <div class="typo-row"><span class="typo-label">Word Spacing</span><input type="range" min="0" max="20" value="0" oninput="updateSetting('ws', this.value+'px')"></div>
        <div class="typo-row"><span class="typo-label">Content Width</span><input type="range" min="400" max="1200" value="800" oninput="updateSetting('max-w', this.value+'px')"></div>
    </div>

    <div id="display">Select a Surah...</div>

    <div id="controls">
        <div class="row">
            <button onclick="navSurah(-1)">¬´</button>
            <select id="surah-select" onchange="changeSurah(this.value)" style="width:160px">
                <option value="1">1. Al-Fatiha</option><option value="2">2. Al-Baqarah</option><option value="3">3. Al-Imran</option><option value="4">4. An-Nisa</option><option value="5">5. Al-Ma'idah</option><option value="6">6. Al-An'am</option><option value="7">7. Al-A'raf</option><option value="8">8. Al-Anfal</option><option value="9">9. At-Tawbah</option><option value="10">10. Yunus</option><option value="11">11. Hud</option><option value="12">12. Yusuf</option><option value="13">13. Ar-Ra'd</option><option value="14">14. Ibrahim</option><option value="15">15. Al-Hijr</option><option value="16">16. An-Nahl</option><option value="17">17. Al-Isra</option><option value="18">18. Al-Kahf</option><option value="19">19. Maryam</option><option value="20">20. Ta-Ha</option><option value="21">21. Al-Anbiya</option><option value="22">22. Al-Hajj</option><option value="23">23. Al-Mu'minun</option><option value="24">24. An-Nur</option><option value="25">25. Al-Furqan</option><option value="26">26. Ash-Shu'ara</option><option value="27">27. An-Naml</option><option value="28">28. Al-Qasas</option><option value="29">29. Al-Ankabut</option><option value="30">30. Ar-Rum</option><option value="31">31. Luqman</option><option value="32">32. As-Sajdah</option><option value="33">33. Al-Ahzab</option><option value="34">34. Saba</option><option value="35">35. Fatir</option><option value="36">36. Ya-Sin</option><option value="37">37. As-Saffat</option><option value="38">38. Sad</option><option value="39">39. Az-Zumar</option><option value="40">40. Ghafir</option><option value="41">41. Fussilat</option><option value="42">42. Ash-Shura</option><option value="43">43. Az-Zukhruf</option><option value="44">44. Ad-Dukhan</option><option value="45">45. Al-Jathiyah</option><option value="46">46. Al-Ahqaf</option><option value="47">47. Muhammad</option><option value="48">48. Al-Fath</option><option value="49">49. Al-Hujurat</option><option value="50">50. Qaf</option><option value="51">51. Adh-Dhariyat</option><option value="52">52. At-Tur</option><option value="53">53. An-Najm</option><option value="54">54. Al-Qamar</option><option value="55">55. Ar-Rahman</option><option value="56">56. Al-Waqi'ah</option><option value="57">57. Al-Hadid</option><option value="58">58. Al-Mujadila</option><option value="59">59. Al-Hashr</option><option value="60">60. Al-Mumtahanah</option><option value="61">61. As-Saff</option><option value="62">62. Al-Jumu'ah</option><option value="63">63. Al-Munafiqun</option><option value="64">64. At-Taghabun</option><option value="65">65. At-Talaq</option><option value="66">66. At-Tahrim</option><option value="67">67. Al-Mulk</option><option value="68">68. Al-Qalam</option><option value="69">69. Al-Haqqah</option><option value="70">70. Al-Ma'arij</option><option value="71">71. Nuh</option><option value="72">72. Al-Jinn</option><option value="73">73. Al-Muzzammil</option><option value="74">74. Al-Muddathir</option><option value="75">75. Al-Qiyamah</option><option value="76">76. Al-Insan</option><option value="77">77. Al-Mursalat</option><option value="78">78. An-Naba</option><option value="79">79. An-Nazi'at</option><option value="80">80. Abasa</option><option value="81">81. At-Takwir</option><option value="82">82. Al-Infitar</option><option value="83">83. Al-Mutaffifin</option><option value="84">84. Al-Inshiqaq</option><option value="85">85. Al-Buruj</option><option value="86">86. At-Tariq</option><option value="87">87. Al-A'la</option><option value="88">88. Al-Ghashiyah</option><option value="89">89. Al-Fajr</option><option value="90">90. Al-Balad</option><option value="91">91. Ash-Shams</option><option value="92">92. Al-Layl</option><option value="93">93. Ad-Duhaa</option><option value="94">94. Ash-Sharh</option><option value="95">95. At-Tin</option><option value="96">96. Al-Alaq</option><option value="97">97. Al-Qadr</option><option value="98">98. Al-Bayyinah</option><option value="99">99. Az-Zalzalah</option><option value="100">100. Al-Adiyat</option><option value="101">101. Al-Qari'ah</option><option value="102">102. At-Takathur</option><option value="103">103. Al-Asr</option><option value="104">104. Al-Humazah</option><option value="105">105. Al-Fil</option><option value="106">106. Quraysh</option><option value="107">107. Al-Ma'un</option><option value="108">108. Al-Kawthar</option><option value="109">109. Al-Kafirun</option><option value="110">110. An-Nasr</option><option value="111">111. Al-Masad</option><option value="112">112. Al-Ikhlas</option><option value="113">113. Al-Falaq</option><option value="114">114. An-Nas</option>
            </select>
            <button onclick="navSurah(1)">¬ª</button>
            <div style="display:flex; align-items:center; gap:5px;">
                <select id="view-mode" onchange="changeViewMode(this.value)" style="width:100px">
                    <option value="all">All</option><option value="5">5</option><option value="10">10</option><option value="custom">#</option>
                </select>
                <input type="number" id="custom-chunk-input" min="1" max="286" placeholder="#" onchange="setCustomChunk(this.value)">
            </div>
            <div id="page-controls" class="page-nav hidden">
                <button class="big-btn" onclick="changePage(-1)">‚Äπ</button>
                <span id="page-info" style="font-size:0.9rem"></span>
                <button class="big-btn" onclick="changePage(1)">‚Ä∫</button>
            </div>
        </div>
        <div class="row">
            <select id="reciter-select" style="width:160px" onchange="saveState()">
                <option value="warsh/warsh_ibrahim_aldosary_128kbps">Ibrahim Al-Dosary</option>
                <option value="warsh/warsh_yassin_al_jazaery_64kbps">Yassin Al-Jazaery</option>
                <option value="warsh/warsh_Abdul_Basit_128kbps">Abdul Basit (Warsh)</option>
            </select>
            <input type="number" id="v_start" value="1" min="1" style="width:50px">
            <input type="number" id="v_end" value="1" min="1" style="width:50px">
            <label><input type="checkbox" id="loop-box"> Loop</label>
            <button class="primary" onclick="play()" id="play-btn">‚ñ∂ PLAY</button>
            <button onclick="stop()">‚èπ</button>
        </div>
        <div id="status">Ready</div>
    </div>

    <!-- Dev Panel Modal -->
    <div id="dev-modal-overlay" class="modal-overlay">
        <div class="modal" style="width: 700px;">
            <div class="modal-header">
                <h3>üé® Developer Mode - Color Editor</h3>
                <button onclick="closeDevPanel()" style="font-size:1.5rem; background:none; border:none; cursor:pointer;">√ó</button>
            </div>
            <div class="modal-tabs">
            <div class="modal-tab active" onclick="showDevTab('conditions')">Conditions</div>
            <div class="modal-tab" onclick="showDevTab('overrides')">Overrides</div>
            <div class="modal-tab" onclick="showDevTab('rules')">Colors</div>
            <div class="modal-tab" onclick="showDevTab('github')">GitHub</div>
            </div>
            <div class="modal-body">
            <div id="tab-conditions" class="tab-content active">
            <p style="margin-top:0;color:#666;">Edit detection conditions for each rule.</p>
            <div id="conditions-list"></div>
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">
            <h4>Letter Sets</h4>
            <div id="sets-list"></div>
            </div>
            <button onclick="resetAllConditions()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Reset All</button>
            </div>
            <div id="tab-overrides" class="tab-content">
                    <p style="margin-top:0; color:#666;">Click on any letter in the verses to change its color individually.</p>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Active Overrides: <strong id="override-total">0</strong></span>
                        <button onclick="clearAllOverrides()" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Clear All</button>
                    </div>
                    <div id="override-list" style="max-height:300px; overflow-y:auto;"></div>
                </div>
                
                <!-- Rules Tab -->
                <div id="tab-rules" class="tab-content">
                    <div id="rules-list"></div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button onclick="resetAllRules()">Reset to Defaults</button>
                        <button onclick="exportConfig()">Export JSON</button>
                    </div>
                </div>
                
                <!-- GitHub Tab -->
                <div id="tab-github" class="tab-content">
                    <p style="margin-top:0">Save your color configuration to GitHub.</p>
                    <div style="background:#f3f4f6; padding:10px; border-radius:6px; font-family:monospace; font-size:0.8rem; margin-bottom:15px;">
üìÅ your-repo/
‚îú‚îÄ‚îÄ üìÅ data/
‚îú‚îÄ‚îÄ üìÑ engine.js
‚îú‚îÄ‚îÄ üìÑ index.html
‚îú‚îÄ‚îÄ üìÑ tajweed-config.json  ‚Üê Saved here
                    </div>
                    <div style="display:grid; gap:10px;">
                        <div>
                            <label>Personal Access Token</label>
                            <input type="password" id="gh-token" placeholder="ghp_xxx..." style="width:100%">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <label>Owner (username)</label>
                                <input type="text" id="gh-owner" placeholder="your-username" style="width:100%">
                            </div>
                            <div>
                                <label>Repo Name</label>
                                <input type="text" id="gh-repo" placeholder="your-repo" style="width:100%">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <label>Branch</label>
                                <input type="text" id="gh-branch" value="main" style="width:100%">
                            </div>
                            <div>
                                <label>File Path</label>
                                <input type="text" id="gh-path" value="tajweed-config.json" style="width:100%">
                            </div>
                        </div>
                    </div>
                    <button onclick="saveToGitHub()" style="width:100%; margin-top:15px; padding:10px; background:#22c55e; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                        Save to GitHub
                    </button>
                    <div id="gh-status" style="margin-top:10px; text-align:center;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Letter Color Popup -->
    <div id="letter-popup" class="letter-popup">
        <h4 style="margin-top:0">Edit Letter Color</h4>
        <div class="letter-preview" id="letter-preview">ÿ®</div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <label>Color:</label>
            <input type="color" id="letter-color" style="width:50px; height:40px; cursor:pointer;">
            <input type="text" id="letter-color-text" style="flex:1" placeholder="#ff0000">
        </div>
        <div style="margin-bottom:15px;">
            <label><input type="checkbox" id="letter-bold"> Bold</label>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="saveLetterColor()" style="flex:1; background:#22c55e; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">Save</button>
            <button onclick="removeLetterOverrideUI()" style="background:#f3f4f6; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Reset</button>
            <button onclick="closeLetterPopup()" style="background:#f3f4f6; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script src="engine.js"></script>
    <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    // State
    let state = { surah: 1, chunkSize: 'all', offset: 1, data: null };
    let bookmarks = [], fullQuranCache = null, playing = false, stopReq = false;
    const aud = new Audio();
    let selectedLetter = null;

    // Dev Mode Functions
    function toggleDevMode() {
        const badge = document.getElementById('dev-badge');
        const banner = document.getElementById('dev-banner');
        const panelBtn = document.getElementById('dev-panel-btn');
        const isDev = isDevMode();
        
        setDevMode(!isDev);
        
        if (!isDev) {
            badge.classList.add('active');
            badge.textContent = 'Dev Mode ON';
            banner.style.display = 'block';
            panelBtn.style.display = 'inline-block';
        } else {
            badge.classList.remove('active');
            badge.textContent = 'Dev Mode';
            banner.style.display = 'none';
            panelBtn.style.display = 'none';
        }
        
        render();
        updateOverrideCount();
    }

    function openDevPanel() {
    document.getElementById('dev-modal-overlay').classList.add('show');
    renderConditionsList();
    renderSetsList();
    renderRulesList();
    renderOverrideList();
}

    function closeDevPanel() {
        document.getElementById('dev-modal-overlay').classList.remove('show');
    }

    function showDevTab(tabName) {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    }

  function renderRulesList() {
    const rules = getRules();
    
    const PATTERN_DEFS = {
        'tj-ghunnah': [
            {id:'noonShadda', label:'Noon with Shadda (ŸÜŸë)'},
            {id:'meemShadda', label:'Meem with Shadda (ŸÖŸë)'},
            {id:'ikhfa', label:'Ikhfa (ŸÜ + ÿ™ÿ´ÿ¨ÿØÿ∞ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ŸÅŸÇŸÉ)'},
            {id:'iqlab', label:'Iqlab (ŸÜ/ŸÖ + ÿ®)'},
            {id:'idghamGhunnah', label:'Idgham with Ghunnah'},
            {id:'meemSakinah', label:'Meem Sakinah before ÿ®'}
        ],
        'tj-qalqalah': [
            {id:'withSukun', label:'With Sukun'},
            {id:'withShadda', label:'With Shadda'},
            {id:'atEnd', label:'At End of Word'}
        ],
        'tj-ra-heavy': [
            {id:'withFatha', label:'With Fatha'},
            {id:'withDamma', label:'With Damma'},
            {id:'sukunAfterFatha', label:'Sukun after Fatha'},
            {id:'sukunAfterDamma', label:'Sukun after Damma'},
            {id:'withShadda', label:'With Shadda'}
        ],
        'tj-ra-light': [
            {id:'withKasra', label:'With Kasra'},
            {id:'sukunAfterKasra', label:'Sukun after Kasra'}
        ],
        'tj-madd': [
            {id:'beforeHamza', label:'Before Hamza'},
            {id:'beforeSukun', label:'Before Sukun'},
            {id:'beforeShadda', label:'Before Shadda'}
        ],
        'tj-silent': [
            {id:'lamShamsiyya', label:'Lam Shamsiyya'},
            {id:'idghamNoGhunnah', label:'Idgham without Ghunnah'},
            {id:'noonIdgham', label:'Noon in Idgham'},
            {id:'meemIdgham', label:'Meem in Idgham'}
        ]
    };
    
    const html = rules.map(r => {
        const isCustom = r.id.startsWith('tj-custom-');
        const patternDefs = PATTERN_DEFS[r.id];
        
        let patternsHtml = '';
        if (patternDefs && r.patterns) {
            patternsHtml = '<div style="margin-top:10px;padding:10px;background:#f9fafb;border-radius:6px">' +
                '<div style="font-size:0.85rem;color:#666;margin-bottom:8px">Conditions:</div>' +
                '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px">' +
                patternDefs.map(p => 
                    '<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:#fff;border-radius:4px;border:1px solid #e5e7eb">' +
                    '<input type="checkbox" id="pat-' + r.id + '-' + p.id + '" ' + 
                    (r.patterns[p.id] ? 'checked' : '') + 
                    ' onchange="updatePattern(\'' + r.id + '\',\'' + p.id + '\',this.checked)" style="cursor:pointer">' +
                    '<label for="pat-' + r.id + '-' + p.id + '" style="cursor:pointer;font-size:0.85rem">' + p.label + '</label></div>'
                ).join('') + '</div></div>';
        }
        
        return '<div class="rule-card">' +
            '<div class="rule-card-header">' +
                '<div><strong>' + r.name + '</strong> (' + r.nameAr + ')' + 
                (isCustom ? ' <span style="background:#22c55e;color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-left:5px">CUSTOM</span>' : '') + '</div>' +
                '<div>' + (isCustom ? '<button class="btn-small btn-danger" onclick="deleteRuleUI(\'' + r.id + '\')">Delete</button> ' : '') +
                '<button class="btn-small btn-secondary" onclick="resetSingleRuleUI(\'' + r.id + '\')">Reset</button></div>' +
            '</div>' +
            '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">' +
                '<div class="color-preview" style="background:' + r.color + '"></div>' +
                '<input type="color" value="' + r.color + '" onchange="updateRuleColorUI(\'' + r.id + '\',this.value)" class="color-input">' +
                '<input type="text" value="' + r.color + '" onchange="updateRuleColorUI(\'' + r.id + '\',this.value)" style="flex:1">' +
                '<label><input type="checkbox" ' + (r.bold ? 'checked' : '') + ' onchange="updateRuleBold(\'' + r.id + '\',this.checked)"> Bold</label>' +
            '</div>' +
            '<div style="display:flex;align-items:center;gap:10px">' +
                '<label style="min-width:60px;font-size:0.85rem;color:#666">Letters:</label>' +
                '<input type="text" value="' + (r.letters || '') + '" onchange="updateRuleLettersUI(\'' + r.id + '\',this.value)" style="flex:1;font-family:\'Amiri\',serif;font-size:1.2rem;direction:rtl;padding:8px;border:1px solid var(--border);border-radius:6px" placeholder="Arabic letters...">' +
            '</div>' +
            patternsHtml +
        '</div>';
    }).join('');
    
    document.getElementById('rules-list').innerHTML = 
        '<div style="background:#f0fdf4;border:2px dashed #22c55e;border-radius:8px;padding:15px;margin-bottom:15px">' +
            '<h4 style="margin:0 0 10px 0;color:#16a34a">‚ûï Add New Custom Rule</h4>' +
            '<div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">' +
                '<div><label style="font-size:0.8rem">Name</label><input type="text" id="new-rule-name" placeholder="My Rule" style="width:120px"></div>' +
                '<div><label style="font-size:0.8rem">Arabic</label><input type="text" id="new-rule-name-ar" placeholder="ÿßÿ≥ŸÖ" style="width:80px;direction:rtl"></div>' +
                '<div><label style="font-size:0.8rem">Color</label><input type="color" id="new-rule-color" value="#ff0000" style="width:50px;height:32px"></div>' +
                '<button onclick="addNewRuleUI()" class="btn-small btn-success" style="padding:8px 15px">Add</button>' +
            '</div>' +
        '</div>' + html +
        '<div style="margin-top:15px;display:flex;gap:10px">' +
            '<button onclick="resetAllRulesUI()" class="btn-small btn-secondary">Reset All</button>' +
            '<button onclick="exportConfig()" class="btn-small">Export JSON</button>' +
        '</div>';
}

    function updateRuleColorUI(ruleId, color) {
        updateRuleColor(ruleId, color);
        renderRulesList();
        render();
        // Inject dynamic CSS
        injectDynamicCSS();
    }
function updateRuleBold(ruleId, bold) {
    updateRuleProperty(ruleId, 'bold', bold);
    renderRulesList();
    render();
    injectDynamicCSS();
}

function updateRuleLettersUI(ruleId, letters) {
    updateRuleLetters(ruleId, letters);
    render();
}
function updatePattern(ruleId, patternId, enabled) {
    updateRulePattern(ruleId, patternId, enabled);
    render();
}
function addNewRuleUI() {
    const name = document.getElementById('new-rule-name').value.trim();
    const nameAr = document.getElementById('new-rule-name-ar').value.trim();
    const color = document.getElementById('new-rule-color').value;
    
    if (!name) {
        alert('Please enter a rule name');
        return;
    }
    
    addNewRule(name, nameAr, color);
    
    document.getElementById('new-rule-name').value = '';
    document.getElementById('new-rule-name-ar').value = '';
    
    renderRulesList();
    injectDynamicCSS();
}

function deleteRuleUI(ruleId) {
    if (confirm('Delete this custom rule?')) {
        deleteRule(ruleId);
        renderRulesList();
        render();
        injectDynamicCSS();
    }
}
    function resetAllRules() {
        resetRules();
        renderRulesList();
        render();
        injectDynamicCSS();
    }

    function renderOverrideList() {
        const overrides = getOverrides();
        const list = document.getElementById('override-list');
        
        if (overrides.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No letter overrides yet. Click on letters to add.</div>';
            return;
        }
        
        list.innerHTML = overrides.map((o, i) => `
            <div class="override-item">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="override-letter" style="color:${o.color}">${o.letter}</span>
                    <div style="font-size:0.8rem; color:#666;">
                        Surah ${o.surah}, Verse ${o.verse}, Position ${o.charIndex}
                    </div>
                </div>
                <button onclick="removeOverrideUI(${i})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:1rem;">‚úï</button>
            </div>
        `).join('');
        
        document.getElementById('override-total').textContent = overrides.length;
    }

    function removeOverrideUI(index) {
        const overrides = getOverrides();
        const o = overrides[index];
        removeLetterOverride(o.surah, o.verse, o.charIndex);
        renderOverrideList();
        render();
        updateOverrideCount();
    }

    function clearAllOverrides() {
        clearAllOverrides();
        renderOverrideList();
        render();
        updateOverrideCount();
    }

    function updateOverrideCount() {
        const count = getOverrides().length;
        const el = document.getElementById('override-count');
        el.textContent = count > 0 ? `| ${count} overrides` : '';
    }

    // Letter click handler
    document.addEventListener('click', function(e) {
        if (!isDevMode()) return;
        
        const letterUnit = e.target.closest('.letter-unit');
        if (!letterUnit) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        selectedLetter = {
            index: parseInt(letterUnit.dataset.letterIndex),
            surah: parseInt(letterUnit.dataset.surah),
            verse: parseInt(letterUnit.dataset.verse),
            letter: letterUnit.dataset.letter
        };
        
        // Find current override
        const overrides = getOverrides();
        const existing = overrides.find(o => 
            o.surah === selectedLetter.surah && 
            o.verse === selectedLetter.verse && 
            o.charIndex === selectedLetter.index
        );
        
        // Get current style from the element
        const computedStyle = window.getComputedStyle(letterUnit);
        const currentColor = existing ? existing.color : (computedStyle.color || '#000000');
        const currentBold = existing ? existing.bold : (computedStyle.fontWeight === 'bold');
        
        // Convert RGB to hex if needed
        let hexColor = currentColor;
        if (currentColor.startsWith('rgb')) {
            const rgb = currentColor.match(/\d+/g);
            if (rgb) {
                hexColor = '#' + rgb.slice(0,3).map(x => parseInt(x).toString(16).padStart(2,'0')).join('');
            }
        }
        
        document.getElementById('letter-preview').textContent = selectedLetter.letter;
        document.getElementById('letter-preview').style.color = hexColor;
        document.getElementById('letter-color').value = hexColor;
        document.getElementById('letter-color-text').value = hexColor;
        document.getElementById('letter-bold').checked = currentBold;
        document.getElementById('letter-popup').classList.add('show');
    });

    function saveLetterColor() {
        if (!selectedLetter) return;
        
        const color = document.getElementById('letter-color-text').value || document.getElementById('letter-color').value;
        const bold = document.getElementById('letter-bold').checked;
        
        setLetterOverride(
            selectedLetter.surah,
            selectedLetter.verse,
            selectedLetter.index,
            selectedLetter.letter,
            color,
            bold
        );
        
        closeLetterPopup();
        render();
        renderOverrideList();
        updateOverrideCount();
    }

    function removeLetterOverrideUI() {
        if (!selectedLetter) return;
        
        removeLetterOverride(
            selectedLetter.surah,
            selectedLetter.verse,
            selectedLetter.index
        );
        
        closeLetterPopup();
        render();
        renderOverrideList();
        updateOverrideCount();
    }

    function closeLetterPopup() {
        document.getElementById('letter-popup').classList.remove('show');
        selectedLetter = null;
    }

    // Sync color input with text input
    document.getElementById('letter-color').addEventListener('input', function() {
        document.getElementById('letter-color-text').value = this.value;
    });
    document.getElementById('letter-color-text').addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            document.getElementById('letter-color').value = this.value;
        }
    });

    // GitHub Save
    async function saveToGitHub() {
        const token = document.getElementById('gh-token').value;
        const owner = document.getElementById('gh-owner').value;
        const repo = document.getElementById('gh-repo').value;
        const branch = document.getElementById('gh-branch').value || 'main';
        const path = document.getElementById('gh-path').value || 'tajweed-config.json';
        const status = document.getElementById('gh-status');
        
        if (!token || !owner || !repo) {
            status.innerHTML = '<span style="color:#ef4444">Please fill in all fields</span>';
            return;
        }
        
        status.innerHTML = 'Checking file...';
        
        try {
            const config = getConfig();
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(config, null, 2))));
            
            // Get existing file SHA first
            let sha = null;
            const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
            
            const getRes = await fetch(getUrl, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Warsh-Reader-App'
                }
            });
            
            if (getRes.ok) {
                const data = await getRes.json();
                sha = data.sha;
                status.innerHTML = 'Updating existing file...';
            } else if (getRes.status === 404) {
                status.innerHTML = 'Creating new file...';
            } else {
                const errData = await getRes.json();
                throw new Error('GET failed: ' + (errData.message || getRes.status));
            }
            
            // Now PUT the file
            const body = {
                message: `Update tajweed config - ${new Date().toISOString()}`,
                content: content,
                branch: branch
            };
            if (sha) body.sha = sha;
            
            const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Warsh-Reader-App',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            if (!putRes.ok) {
                const err = await putRes.json();
                throw new Error(err.message || 'Failed to save');
            }
            
            status.innerHTML = '<span style="color:#22c55e">‚úì Saved successfully!</span>';
            
            // Save GitHub config
            localStorage.setItem('warsh_github_config', JSON.stringify({ token, owner, repo, branch, path }));
        } catch(e) {
            status.innerHTML = `<span style="color:#ef4444">Error: ${e.message}</span>`;
        }
    }

    // Export config
    function exportConfig() {
        const config = getConfig();
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tajweed-config.json';
        a.click();
        URL.revokeObjectURL(url);
    }
// Conditions Editor
function renderConditionsList() {
    const conditions = getConditions();
    const triggerOptions = getTriggerOptions();
    const rules = getRules();
    
    const conditionKeys = ['qalqalah', 'ghunnah', 'heavy', 'raHeavy', 'raLight', 'madd', 'silent', 'special'];
    
    let html = '';
    conditionKeys.forEach(key => {
        const cond = conditions[key];
        if (!cond) return;
        
        const rule = rules.find(r => r.id === cond.id);
        const color = rule ? rule.color : '#666';
        const opts = triggerOptions[key] || { vowels: [], options: [] };
        const vowels = opts.vowels || [];
        const options = opts.options || [];
        
        html += `
        <div class="condition-card" id="cond-card-${key}" style="border:1px solid var(--border); border-radius:8px; margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:var(--bg); cursor:pointer; border-bottom:1px solid var(--border);" onclick="toggleConditionCard('${key}')">
                <div>
                    <span style="display:inline-block; width:12px; height:12px; background:${color}; border-radius:50%; margin-left:8px;"></span>
                    <strong>${cond.name}</strong> 
                    <span style="color:#666; font-size:0.85rem;">(${cond.nameAr})</span>
                </div>
                <span id="toggle-${key}">‚ñº</span>
            </div>
            <div id="cond-body-${key}" style="padding:15px; display:none;">
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <label style="min-width:80px; font-weight:bold;">Consonants:</label>
                    <input type="text" value="${cond.consonants || ''}" 
                        onchange="updateConditionField('${key}', 'consonants', this.value)"
                        style="flex:1; direction:rtl; font-family:'Amiri',serif; font-size:1.2rem; padding:8px; border:1px solid var(--border); border-radius:6px;">
                </div>`;
        
        // Vowels section
        if (vowels.length > 0) {
            html += `
                <div style="margin-top:12px;">
                    <label style="font-weight:bold; margin-bottom:8px; display:block;">Vowels:</label>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:8px;">`;
            
            vowels.forEach(v => {
                const isActive = cond.vowels && cond.vowels.includes(v.id);
                html += `
                <div class="vowel-item" 
                     onclick="toggleVowel('${key}', '${v.id}')"
                     style="display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer; ${isActive ? 'background:var(--active-bg); border-color:var(--accent);' : ''}">
                    <span style="width:18px; height:18px; border:2px solid var(--border); border-radius:4px; display:flex; align-items:center; justify-content:center; ${isActive ? 'background:var(--accent); border-color:var(--accent);' : ''}">${isActive ? '<span style="color:white; font-size:12px;">‚úì</span>' : ''}</span>
                    <span>${v.label}</span>
                </div>`;
            });
            
            html += `</div></div>`;
        }
        
        // Options section
        if (options.length > 0) {
            html += `
                <div style="margin-top:12px;">
                    <label style="font-weight:bold; margin-bottom:8px; display:block;">Options:</label>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:8px;">`;
            
            options.forEach(o => {
                const isActive = cond[o.id] === true;
                html += `
                <div class="option-item" 
                     onclick="toggleOption('${key}', '${o.id}')"
                     style="display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer; ${isActive ? 'background:var(--active-bg); border-color:var(--accent);' : ''}">
                    <span style="width:18px; height:18px; border:2px solid var(--border); border-radius:4px; display:flex; align-items:center; justify-content:center; ${isActive ? 'background:var(--accent); border-color:var(--accent);' : ''}">${isActive ? '<span style="color:white; font-size:12px;">‚úì</span>' : ''}</span>
                    <span>${o.label}</span>
                </div>`;
            });
            
            html += `</div></div>`;
        }
        
        html += `</div></div>`;
    });
    
    document.getElementById('conditions-list').innerHTML = html;
}
function updateConditionField(key, field, value) {
    updateCondition(key, { [field]: value });
    render();
}

function toggleVowel(condKey, vowelId) {
    const conditions = getConditions();
    const cond = conditions[condKey];
    if (!cond) return;
    
    let vowels = [...(cond.vowels || [])];
    const idx = vowels.indexOf(vowelId);
    
    if (idx >= 0) {
        vowels.splice(idx, 1);
    } else {
        vowels.push(vowelId);
    }
    
    updateCondition(condKey, { vowels });
    renderConditionsList();
    render();
}

function toggleOption(condKey, optionId) {
    const conditions = getConditions();
    const cond = conditions[condKey];
    if (!cond) return;
    
    updateCondition(condKey, { [optionId]: !cond[optionId] });
    renderConditionsList();
    render();
}        

function toggleConditionCard(key) {
    const body = document.getElementById('cond-body-' + key);
    const toggle = document.getElementById('toggle-' + key);
    if (body.style.display === 'none') {
        body.style.display = 'block';
        toggle.textContent = '‚ñ≤';
    } else {
        body.style.display = 'none';
        toggle.textContent = '‚ñº';
    }
}

function updateConditionLetters(key, value) {
    updateCondition(key, { consonants: value });
    render();
}

function toggleTrigger(condKey, triggerId) {
    const conditions = getConditions();
    const cond = conditions[condKey];
    if (!cond) return;
    
    let triggers = [...cond.triggers];
    const idx = triggers.indexOf(triggerId);
    
    if (idx >= 0) {
        triggers.splice(idx, 1);
    } else {
        triggers.push(triggerId);
    }
    
    updateCondition(condKey, { triggers });
    renderConditionsList();
    render();
}

function renderSetsList() {
    const sets = getSets();
    
    const setLabels = {
        idghamWithGhunnah: 'Idgham with Ghunnah (ŸäŸÜŸÖŸà)',
        idghamNoGhunnah: 'Idgham no Ghunnah (ŸÑÿ±)',
        ikhfa: 'Ikhfa Letters',
        lamShamsiyya: 'Lam Shamsiyya Letters',
        hamzaLetters: 'Hamza Forms'
    };
    
    let html = '';
    Object.keys(sets).forEach(key => {
        html += `
        <div style="display:flex; align-items:center; gap:15px; padding:10px; border:1px solid var(--border); border-radius:6px; margin-bottom:8px;">
            <label style="min-width:160px; font-weight:bold; font-size:0.9rem;">${setLabels[key] || key}</label>
            <input type="text" value="${sets[key]}" 
                onchange="updateSetUI('${key}', this.value)"
                style="flex:1; direction:rtl; font-family:'Amiri',serif; font-size:1.2rem; padding:8px; border:1px solid var(--border); border-radius:6px;">
        </div>`;
    });
    
    document.getElementById('sets-list').innerHTML = html;
}

function updateSetUI(key, value) {
    updateSet(key, value);
    render();
}

function resetAllConditions() {
    if (confirm('Reset all conditions and letter sets to defaults?')) {
        resetConditions();
        resetSets();
        renderConditionsList();
        renderSetsList();
        render();
    }
}
    // Original app functions
    function init() {
        const saved = JSON.parse(localStorage.getItem('warsh_state'));
        if(saved) {
            state.surah = saved.surah || 1; 
            state.chunkSize = saved.chunkSize || 'all'; 
            state.offset = saved.offset || 1;
            document.getElementById('reciter-select').value = saved.reciter || "warsh/warsh_ibrahim_aldosary_128kbps";
            if(saved.theme === 'dark') document.body.classList.add('dark');
            if(saved.css) Object.keys(saved.css).forEach(k => document.documentElement.style.setProperty(k, saved.css[k]));
            document.getElementById('view-mode').value = state.chunkSize === 'all' ? 'all' : (state.chunkSize > 10 ? 'custom' : state.chunkSize);
            updateNavVisibility();
        }
        document.getElementById('surah-select').value = state.surah;
        const bm = JSON.parse(localStorage.getItem('warsh_bookmarks')); if(bm) bookmarks = bm;
        renderBMList(); 
        changeSurah(state.surah, true);
        
        // Load GitHub config
        const ghConfig = JSON.parse(localStorage.getItem('warsh_github_config'));
        if (ghConfig) {
            document.getElementById('gh-token').value = ghConfig.token || '';
            document.getElementById('gh-owner').value = ghConfig.owner || '';
            document.getElementById('gh-repo').value = ghConfig.repo || '';
            document.getElementById('gh-branch').value = ghConfig.branch || 'main';
            document.getElementById('gh-path').value = ghConfig.path || 'tajweed-config.json';
        }
        
        updateOverrideCount();
        
        // Inject dynamic CSS for custom colors
        injectDynamicCSS();
    }

    function saveState() {
        localStorage.setItem('warsh_state', JSON.stringify({
            surah: state.surah, chunkSize: state.chunkSize, offset: state.offset,
            reciter: document.getElementById('reciter-select').value,
            theme: document.body.classList.contains('dark') ? 'dark' : 'light',
            css: {
                '--sz': getComputedStyle(document.documentElement).getPropertyValue('--sz'),
                '--lh': getComputedStyle(document.documentElement).getPropertyValue('--lh'),
                '--ws': getComputedStyle(document.documentElement).getPropertyValue('--ws'),
                '--max-w': getComputedStyle(document.documentElement).getPropertyValue('--max-w')
            }
        }));
    }

    async function changeSurah(id, skipOffsetReset) { state.surah = parseInt(id); if(!skipOffsetReset) state.offset = 1; document.getElementById('surah-select').value = state.surah; saveState(); await loadData(); render(); }
    function navSurah(dir) { let next = state.surah + dir; if(next >= 1 && next <= 114) changeSurah(next); }
    function changeViewMode(mode) { const inp = document.getElementById('custom-chunk-input'); if (mode === 'custom') { inp.classList.add('show'); inp.focus(); } else { inp.classList.remove('show'); state.chunkSize = mode === 'all' ? 'all' : parseInt(mode); state.offset = 1; render(); } updateNavVisibility(); saveState(); }
    function setCustomChunk(val) { let n = parseInt(val); if (n && n > 0) { state.chunkSize = n; state.offset = 1; render(); updateNavVisibility(); saveState(); } }
    function updateNavVisibility() { const nav = document.getElementById('page-controls'); if(state.chunkSize === 'all') nav.classList.add('hidden'); else nav.classList.remove('hidden'); }
    function changePage(dir) { if(state.chunkSize === 'all') return; const next = state.offset + (dir * state.chunkSize); if(next >= 1 && next <= state.data.verses.length) { state.offset = next; render(); saveState(); } }

    async function loadData() {
        document.getElementById('status').innerText = "Loading data...";
        try { const res = await fetch(`data/${state.surah}.json`); if(!res.ok) throw new Error("File not found"); state.data = await res.json(); document.getElementById('surah-title').innerText = `${state.surah}. ${state.data.name_ar} (${state.data.name_en})`; document.getElementById('status').innerText = "Ready"; } catch(e) { document.getElementById('display').innerHTML = `<div style="color:red;text-align:center">Error: ${e.message}</div>`; }
    }

    function render() {
        if(!state.data) return;
        const div = document.getElementById('display'); let html = "";
        if (state.surah != 1 && state.surah != 9 && state.offset === 1) { 
            const bism = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê"; 
            html += `<div style="text-align:center; margin-bottom:20px; font-size:0.9em; opacity:0.8">${renderVerse(bism, 0, 0)}</div>`; 
        }
        let startIdx = state.offset - 1; 
        let endIdx = state.chunkSize === 'all' ? state.data.verses.length : Math.min(startIdx + state.chunkSize, state.data.verses.length); 
        const chunk = state.data.verses.slice(startIdx, endIdx);
        chunk.forEach((txt, i) => { 
            let n = startIdx + i + 1; 
            let isSaved = bookmarks.some(b => b.s === state.surah && b.v === n); 
            let starClass = isSaved ? 'bm-icon saved' : 'bm-icon'; 
            html += `<div class="verse" id="v${n}" onclick="pick(${n})">${renderVerse(txt, state.surah, n)} <span class="num">${n} <span class="${starClass}" onclick="toggleBM(event, ${n})">‚òÖ</span></span></div>`; 
        });
        div.innerHTML = html; 
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if(state.chunkSize !== 'all') document.getElementById('page-info').innerText = `${state.offset}-${endIdx}`; 
        document.getElementById('v_start').value = state.offset; 
        document.getElementById('v_end').value = endIdx;
    }

    async function runGlobalSearch() {
        const q = document.getElementById('search-input').value.trim(); const resDiv = document.getElementById('search-results'); const stat = document.getElementById('search-status');
        if(!q) return; resDiv.innerHTML = ""; stat.innerText = "Indexing entire Quran...";
        if (!fullQuranCache) { try { fullQuranCache = []; const promises = []; for(let i=1; i<=114; i++) promises.push(fetch(`data/${i}.json`).then(r => r.json())); fullQuranCache = await Promise.all(promises); } catch(e) { stat.innerText = "Error loading Quran data."; return; } }
        stat.innerText = "Searching..."; let results = [];
        fullQuranCache.forEach((surahData, sIdx) => { surahData.verses.forEach((txt, vIdx) => { if (txt.includes(q)) { results.push({ s: sIdx + 1, v: vIdx + 1, name: surahData.name_en, txt: txt }); } }); });
        stat.innerText = `Found ${results.length} matches.`;
        if (results.length === 0) resDiv.innerHTML = "<div class='pop-item'>No matches found.</div>"; else { resDiv.innerHTML = results.map(r => `<div class="pop-item" onclick="jumpTo(${r.s}, ${r.v}); togglePanel('search-panel')"><div><strong>${r.s}. ${r.name} (${r.v})</strong><br><span style="color:#666; font-size:0.8em">${r.txt.substring(0, 60)}...</span></div></div>`).join(''); }
    }

    function toggleBM(e, v) { e.stopPropagation(); const existingIdx = bookmarks.findIndex(b => b.s === state.surah && b.v === v); if(existingIdx >= 0) bookmarks.splice(existingIdx, 1); else bookmarks.push({s: state.surah, v: v, name: state.data.name_en}); localStorage.setItem('warsh_bookmarks', JSON.stringify(bookmarks)); render(); renderBMList(); }
    function renderBMList() { const div = document.getElementById('bm-list'); if(bookmarks.length === 0) { div.innerHTML = "No bookmarks yet."; return; } div.innerHTML = bookmarks.map((b, i) => `<div class="pop-item" onclick="jumpTo(${b.s}, ${b.v})"><span>${b.s}. ${b.name} (${b.v})</span><span style="color:red" onclick="removeBM(event, ${i})">‚úï</span></div>`).join(''); }
    function removeBM(e, i) { e.stopPropagation(); bookmarks.splice(i, 1); localStorage.setItem('warsh_bookmarks', JSON.stringify(bookmarks)); renderBMList(); render(); }
    async function jumpTo(s, v) { await changeSurah(s, true); if (state.chunkSize !== 'all') { const pageStart = Math.floor((v - 1) / state.chunkSize) * state.chunkSize + 1; state.offset = pageStart; } else { state.offset = v; } await render(); setTimeout(() => pick(v), 300); togglePanel('bm-panel'); }
    function pick(n) { document.getElementById('v_start').value = n; hl(n); }
    function hl(n) { document.querySelectorAll('.active').forEach(e=>e.classList.remove('active')); const el=document.getElementById('v'+n); if(el){el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'});}}

    async function play() { if(playing) return; playing=true; stopReq=false; const btn = document.getElementById('play-btn'); const reciter = document.getElementById('reciter-select').value; const sId = String(state.surah).padStart(3,'0'); const st = document.getElementById('status'); btn.innerText = "‚è∏ Playing"; while(true) { const start = parseInt(document.getElementById('v_start').value); const end = parseInt(document.getElementById('v_end').value); for(let a=start; a<=end; a++) { if(stopReq) break; hl(a); st.innerText = `Playing Ayah ${a} / ${end}`; aud.src = `https://everyayah.com/data/${reciter}/${sId}${String(a).padStart(3,'0')}.mp3`; try { await new Promise((resolve) => { aud.onended = resolve; aud.onerror = () => { console.error('Audio Err'); st.innerText="Err: Missing Audio"; resolve(); }; aud.play().catch(resolve); }); } catch(e){} if(!stopReq) await new Promise(r=>setTimeout(r, 200)); } if(stopReq || !document.getElementById('loop-box').checked) break; st.innerText = "Looping..."; await new Promise(r=>setTimeout(r, 500)); } playing=false; btn.innerText = "‚ñ∂ PLAY"; st.innerText = "Ready"; }
    function stop() { stopReq=true; aud.pause(); document.getElementById('play-btn').innerText = "‚ñ∂ PLAY"; }
    function togglePanel(id) { document.querySelectorAll('.popover').forEach(p => { if(p.id !== id) p.classList.remove('show'); }); document.getElementById(id).classList.toggle('show'); }
    function toggleTheme() { document.body.classList.toggle('dark'); saveState(); }
    function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
    function updateSetting(prop, val) { document.documentElement.style.setProperty('--'+prop, val); saveState(); }

    // Load config from GitHub on startup
    async function loadConfigFromServer() {
        try {
            const res = await fetch('tajweed-config.json?t=' + Date.now());
            if (res.ok) {
                const config = await res.json();
                setConfig(config);
                console.log('Loaded config from server');
                injectDynamicCSS();
                if (state.data) render();
                updateOverrideCount();
            }
        } catch(e) {
            console.log('No server config, using localStorage');
        }
    }

    init();
    loadConfigFromServer();
    </script>
</body>
</html>
