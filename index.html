<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsh Reader Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- TAJWEED COLORS --- */
        .tj-ghunnah { color: #16a34a !important; }
        .tj-madd    { color: #dc2626 !important; }
        .tj-qalqalah{ color: #0284c7 !important; }
        .tj-heavy   { color: #1e3a8a !important; font-weight: bold; }
        .tj-light   { color: #06b6d4 !important; }
        .tj-special { color: #d97706 !important; font-weight: bold; }
        .tj-silent  { color: #9ca3af !important; }

        /* --- THEMES --- */
        :root { 
            --bg: #fffcf2; --text: #1a1a1a; --accent: #92400e; --panel: #ffffff; --border: #e5e5e5;
            --active-bg: #fef3c7; --active-border: #92400e;
            --sz: 32px; --lh: 2.8; --ws: normal; --max-w: 800px;
        }
        body.dark {
            --bg: #1f2937; --text: #f3f4f6; --accent: #fbbf24; --panel: #111827; --border: #374151;
            --active-bg: #374151; --active-border: #fbbf24;
        }

        /* --- LAYOUT --- */
        body { font-family: 'Amiri', serif; background: var(--bg); color: var(--text); margin:0; padding-bottom:180px; transition: 0.3s; }
        
        header {
            position: sticky; top: 0; z-index: 900;
            background: var(--panel); border-bottom: 1px solid var(--border);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { margin:0; font-size: 1.2rem; color: var(--accent); }
        .tools { display: flex; gap: 8px; }
        
        /* PANELS (Settings, Search, Bookmarks) */
        .popover {
            display: none; position: absolute; top: 60px; right: 20px; /* Default right for RTL might need left logic */
            background: var(--panel); border: 1px solid var(--border); 
            padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 950; min-width: 250px; max-height: 400px; overflow-y: auto;
        }
        .popover.show { display: block; }
        /* Fix positioning for RTL */
        html[dir="rtl"] .popover { right: auto; left: 20px; }

        .pop-item { 
            padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .pop-item:hover { background: rgba(0,0,0,0.05); }
        .pop-item:last-child { border: none; }

        .typo-row { margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .typo-label { font-size: 0.8rem; opacity: 0.8; }

        /* CONTENT */
        #display { 
            padding: 40px 20px; max-width: var(--max-w); margin: 0 auto; 
            line-height: var(--lh); word-spacing: var(--ws); text-align: justify; 
        }
        
        .verse { 
            display: inline; font-size: var(--sz); cursor: pointer; padding: 4px 0; 
            border-bottom: 1px dashed var(--border); transition: 0.2s; position: relative;
        }
        .verse:hover { background: rgba(0,0,0,0.05); }
        .verse.active { 
            background: var(--active-bg); box-shadow: 0 0 0 3px var(--active-bg); 
            border-radius: 6px; color: var(--text) !important;
        }
        .num { 
            font-size: 0.5em; color: var(--accent); border: 1px solid var(--accent); 
            border-radius: 50%; padding: 0 6px; margin: 0 6px; vertical-align: middle; 
            user-select: none; display: inline-block;
        }
        
        /* BOOKMARK ACTION IN VERSE */
        .bm-icon { font-size: 0.6em; margin-left: 5px; color: #ccc; cursor: pointer; transition: 0.2s; }
        .bm-icon:hover, .bm-icon.saved { color: #f59e0b; }

        /* CONTROLS */
        #controls {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--panel); border-top: 2px solid var(--accent);
            padding: 15px; z-index: 1000; direction: ltr;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        }
        .row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        
        select, input, button { 
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); 
            background: var(--bg); color: var(--text); font-size: 14px; outline: none;
        }
        button { cursor: pointer; font-weight: bold; background: var(--bg); }
        button:hover { background: var(--border); }
        button.primary { background: var(--accent); color: #fff; border: none; }
        button.primary:hover { opacity: 0.9; }
        
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; color: var(--text); }
        input[type=range] { accent-color: var(--accent); cursor: pointer; width: 100%; }
        #status { text-align: center; font-size: 0.8rem; opacity: 0.7; margin-top: 5px; }

        .big-btn { font-size: 1.5rem; padding: 0 15px; line-height: 1; }
        .page-nav { display: flex; gap: 5px; align-items: center; }
        .page-nav.hidden { display: none; }
        #custom-chunk-input { width: 50px; display: none; text-align: center; }
        #custom-chunk-input.show { display: inline-block; }
    </style>
</head>
<body>

    <header>
        <div class="tools">
            <button class="icon-btn" onclick="togglePanel('search-panel')" title="Search">üîç</button>
            <button class="icon-btn" onclick="togglePanel('bm-panel')" title="Bookmarks">‚òÖ</button>
            <button class="icon-btn" onclick="togglePanel('typo-panel')" title="Text Settings">T</button>
            <button class="icon-btn" onclick="toggleTheme()" title="Theme">üåó</button>
            <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">‚õ∂</button>
        </div>
        <h1 id="surah-title">Warsh Reader</h1>
    </header>

    <!-- 1. SEARCH PANEL -->
    <div id="search-panel" class="popover">
        <h3 style="margin-top:0">Search Current Surah</h3>
        <input type="text" id="search-input" placeholder="Type to search..." onkeyup="runSearch()" style="width:90%; margin-bottom:10px">
        <div id="search-results" style="max-height:200px; overflow-y:auto; font-size:0.9rem"></div>
    </div>

    <!-- 2. BOOKMARKS PANEL -->
    <div id="bm-panel" class="popover">
        <h3 style="margin-top:0">Bookmarks</h3>
        <div id="bm-list">No bookmarks yet.</div>
    </div>

    <!-- 3. TYPOGRAPHY PANEL -->
    <div id="typo-panel" class="popover">
        <div class="typo-row">
            <span class="typo-label">Text Size</span>
            <input type="range" min="20" max="70" value="32" oninput="updateSetting('sz', this.value+'px')">
        </div>
        <div class="typo-row">
            <span class="typo-label">Line Height</span>
            <input type="range" min="1.5" max="4.0" step="0.1" value="2.8" oninput="updateSetting('lh', this.value)">
        </div>
        <div class="typo-row">
            <span class="typo-label">Word Spacing</span>
            <input type="range" min="0" max="20" value="0" oninput="updateSetting('ws', this.value+'px')">
        </div>
        <div class="typo-row">
            <span class="typo-label">Content Width</span>
            <input type="range" min="400" max="1200" value="800" oninput="updateSetting('max-w', this.value+'px')">
        </div>
    </div>

    <div id="display">Select a Surah...</div>

    <div id="controls">
        <!-- Row 1: Nav -->
        <div class="row">
            <button onclick="navSurah(-1)" title="Prev Surah">¬´</button>
            <select id="surah-select" onchange="changeSurah(this.value)" style="width:160px"></select>
            <button onclick="navSurah(1)" title="Next Surah">¬ª</button>
            
            <span style="opacity:0.5; margin:0 5px;">|</span>

            <div style="display:flex; align-items:center; gap:5px;">
                <select id="view-mode" onchange="changeViewMode(this.value)" style="width:100px">
                    <option value="all">All</option>
                    <option value="5">5 Verses</option>
                    <option value="10">10 Verses</option>
                    <option value="custom">Custom...</option>
                </select>
                <input type="number" id="custom-chunk-input" min="1" max="286" placeholder="#" onchange="setCustomChunk(this.value)">
            </div>

            <div id="page-controls" class="page-nav hidden">
                <button class="big-btn" onclick="changePage(-1)">‚Äπ</button>
                <span id="page-info" style="font-size:0.9rem; min-width:60px; text-align:center">1-5</span>
                <button class="big-btn" onclick="changePage(1)">‚Ä∫</button>
            </div>
        </div>

        <!-- Row 2: Playback -->
        <div class="row">
            <select id="reciter-select" style="width:160px" onchange="saveState()">
                <option value="warsh/warsh_ibrahim_aldosary_128kbps">Ibrahim Al-Dosary</option>
                <option value="warsh/warsh_yassin_al_jazaery_64kbps">Yassin Al-Jazaery</option>
                <option value="warsh/warsh_Abdul_Basit_128kbps">Abdul Basit (Warsh)</option>
            </select>

            <div style="width:1px; height:20px; background:var(--border)"></div>

            <div style="display:flex; align-items:center; gap:5px; font-size:0.9rem;">
                <span>Ayah:</span>
                <input type="number" id="v_start" value="1" min="1" style="width:50px">
                <span>to</span>
                <input type="number" id="v_end" value="1" min="1" style="width:50px">
            </div>
            
            <label style="display:flex; align-items:center; gap:5px; font-size:0.8rem; cursor:pointer">
                <input type="checkbox" id="loop-box"> Loop
            </label>

            <button class="primary" onclick="play()" id="play-btn">‚ñ∂ PLAY</button>
            <button onclick="stop()">‚èπ</button>
        </div>
        <div id="status">Ready</div>
    </div>

    <script>
    // --- 0. DATA & CONFIG ---
    const SURAH_NAMES = [
        "Al-Fatiha","Al-Baqarah","Al-Imran","An-Nisa","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Tawbah","Yunus",
        "Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra","Al-Kahf","Maryam","Ta-Ha",
        "Al-Anbiya","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara","An-Naml","Al-Qasas","Al-Ankabut","Ar-Rum",
        "Luqman","As-Sajdah","Al-Ahzab","Saba","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir",
        "Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf",
        "Adh-Dhariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadila","Al-Hashr","Al-Mumtahanah",
        "As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij",
        "Nuh","Al-Jinn","Al-Muzzammil","Al-Muddathir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba","An-Nazi'at","Abasa",
        "At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiyah","Al-Fajr","Al-Balad",
        "Ash-Shams","Al-Layl","Ad-Duhaa","Ash-Sharh","At-Tin","Al-Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-Adiyat",
        "Al-Qari'ah","At-Takathur","Al-Asr","Al-Humazah","Al-Fil","Quraysh","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr",
        "Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"
    ];
    
    // --- 1. TAJWEED ENGINE ---
    const SUKUN='\u0652', SHADDA='\u0651', FATHA='\u064E', DAMMA='\u064F', KASRA='\u0650';
    const DAGGER='\u0670', MADD_SIGN='\u0653', WARSH_DOT='\u06EC'; 
    const QALQ='ŸÇÿ∑ÿ®ÿ¨ÿØ', IDGH_GH='ŸäŸÜŸÖŸà', IDGH_NO='ŸÑÿ±', IKHFA='ÿ™ÿ´ÿ¨ÿØÿ∞ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ŸÅŸÇŸÉ';
    const MADD='ÿßŸàŸâ'+DAGGER, HAMZA='ÿ°ÿ£ÿ•ÿ§ÿ¶', HEAVY_LAM_TRIGGERS = 'ÿµÿ∑ÿ∏'; 

    function isDiac(c){const x=c.charCodeAt(0); return (x>=0x064B && x<=0x065F) || x===0x0670 || (x>=0x06D6 && x<=0x06ED);}
    function isLtr(c){const x=c.charCodeAt(0); return !isDiac(c) && x>=0x0600 && x<=0x06FF;}
    function getDiac(t,i){let d=[]; for(let j=i+1;j<t.length&&isDiac(t[j]);j++)d.push(t[j]); return d;}
    function has(t,i,c){return getDiac(t,i).includes(c);}
    function getEnd(t, i){let j=i+1; while(j<t.length&&isDiac(t[j]))j++; return j;}
    function nextL(t,i){for(let j=i+1;j<t.length;j++)if(isLtr(t[j]))return{c:t[j],i:j}; return null;}
    function prevL(t,i){for(let j=i-1;j>=0;j--)if(isLtr(t[j]))return{c:t[j],i:j}; return null;}

    function detect(t){
        const a=[];
        for(let i=0;i<t.length;i++){
            const c=t[i]; if(!isLtr(c)) continue;
            const n=nextL(t,i), p=prevL(t,i), rangeEnd=getEnd(t, i);
            const diacs=getDiac(t,i);
            const isSakin=has(t,i,SUKUN) || (!diacs.length && n && !has(t,i,SHADDA)); 
            const hasVowel=has(t,i,FATHA) || has(t,i,DAMMA) || has(t,i,KASRA);
            const isShadda=has(t,i,SHADDA);
            let rule=null;

            if (has(t, i, WARSH_DOT) || has(t, i, '\u065F')) rule='tj-special';
            else if((c==='ŸÜ'||c==='ŸÖ') && isShadda) rule='tj-ghunnah';
            else if(c==='ŸÜ' && isSakin && n){
                if(IDGH_GH.includes(n.c) || n.c==='ÿ®' || IKHFA.includes(n.c)) rule='tj-ghunnah';
                else if(IDGH_NO.includes(n.c)) rule='tj-silent';
            }
            else if(c==='ŸÖ' && isSakin && n && n.c==='ÿ®') rule='tj-ghunnah';
            else if(QALQ.includes(c) && (has(t,i,SUKUN) || (!hasVowel && !n))) rule='tj-qalqalah';
            else if(c==='ŸÑ' && has(t,i,FATHA) && p && HEAVY_LAM_TRIGGERS.includes(p.c) && (has(t,p.i,FATHA)||has(t,p.i,SUKUN)||!getDiac(t,p.i).length)) rule='tj-heavy';
            else if(c==='ÿ±'){
                if(has(t,i,FATHA) || has(t,i,DAMMA)) rule='tj-heavy';
                if(has(t,i,KASRA)) rule='tj-light'; 
                else if((has(t,i,FATHA) || has(t,i,DAMMA)) && p){
                    if(has(t,p.i,KASRA) || (p.c==='Ÿä' && (has(t,p.i,SUKUN)||!getDiac(t,p.i).length))) rule='tj-light';
                }
            }
            else if(MADD.includes(c) && !hasVowel && !isShadda){
                if(has(t,i,MADD_SIGN)) rule='tj-madd';
                else if(n && (HAMZA.includes(n.c) || has(t,n.i,SUKUN) || has(t,n.i,SHADDA))) rule='tj-madd';
                else if(p && HAMZA.includes(p.c)) rule='tj-madd';
            }
            else if(c==='ŸÑ' && isSakin && n && has(t,n.i,SHADDA)) rule='tj-silent';
            if(rule) a.push({s:i, e:rangeEnd, cls:rule});
        }
        return a;
    }

    function apply(t,ann){
        const m=new Map();
        for(const x of ann) for(let i=x.s;i<x.e;i++) m.set(i,x);
        let h='',cls=null,open=false;
        for(let i=0;i<t.length;i++){
            const x=m.get(i),nc=x?x.cls:null;
            if(nc!==cls){ if(open)h+='</span>'; if(nc){h+=`<span class="${nc}">`;open=true} else open=false; cls=nc; }
            h+=t[i];
        }
        if(open)h+='</span>'; return h;
    }

    // --- 2. STATE & STORAGE ---
    let state = { surah: 1, chunkSize: 'all', offset: 1, data: null };
    let bookmarks = [];
    let playing = false, stopReq = false;
    const aud = new Audio();
    
    // Init
    const sel = document.getElementById('surah-select');
    SURAH_NAMES.forEach((n,i) => {
        let opt = document.createElement('option');
        opt.value = i+1; opt.text = `${i+1}. ${n}`;
        sel.appendChild(opt);
    });

    // --- 3. LOGIC ---
    
    function init() {
        // Load Saved State
        const saved = JSON.parse(localStorage.getItem('warsh_state'));
        if(saved) {
            state.surah = saved.surah || 1;
            state.chunkSize = saved.chunkSize || 'all';
            state.offset = saved.offset || 1;
            document.getElementById('reciter-select').value = saved.reciter || "warsh/warsh_ibrahim_aldosary_128kbps";
            if(saved.theme === 'dark') document.body.classList.add('dark');
            if(saved.css) {
                Object.keys(saved.css).forEach(k => document.documentElement.style.setProperty(k, saved.css[k]));
            }
            // Update UI inputs to match loaded settings
            document.getElementById('view-mode').value = state.chunkSize === 'all' || isNaN(state.chunkSize) ? 'all' : (state.chunkSize > 10 ? 'custom' : state.chunkSize);
            if(state.chunkSize !== 'all') updateNavVisibility();
        }

        // Load Bookmarks
        const bm = JSON.parse(localStorage.getItem('warsh_bookmarks'));
        if(bm) bookmarks = bm;
        renderBMList();

        changeSurah(state.surah, true); // True = skip reset offset
    }

    function saveState() {
        const s = {
            surah: state.surah,
            chunkSize: state.chunkSize,
            offset: state.offset,
            reciter: document.getElementById('reciter-select').value,
            theme: document.body.classList.contains('dark') ? 'dark' : 'light',
            css: {
                '--sz': getComputedStyle(document.documentElement).getPropertyValue('--sz'),
                '--lh': getComputedStyle(document.documentElement).getPropertyValue('--lh'),
                '--ws': getComputedStyle(document.documentElement).getPropertyValue('--ws'),
                '--max-w': getComputedStyle(document.documentElement).getPropertyValue('--max-w')
            }
        };
        localStorage.setItem('warsh_state', JSON.stringify(s));
    }

    async function changeSurah(id, skipOffsetReset) {
        state.surah = parseInt(id); 
        if(!skipOffsetReset) state.offset = 1; 
        document.getElementById('surah-select').value = state.surah;
        saveState();
        await loadData(); render();
    }
    
    function navSurah(dir) {
        let next = state.surah + dir;
        if(next >= 1 && next <= 114) changeSurah(next);
    }

    function changeViewMode(mode) {
        const inp = document.getElementById('custom-chunk-input');
        if (mode === 'custom') { inp.classList.add('show'); inp.focus(); } 
        else { inp.classList.remove('show'); state.chunkSize = mode === 'all' ? 'all' : parseInt(mode); state.offset = 1; render(); }
        updateNavVisibility(); saveState();
    }

    function setCustomChunk(val) {
        let n = parseInt(val);
        if (n && n > 0) { state.chunkSize = n; state.offset = 1; render(); updateNavVisibility(); saveState(); }
    }

    function updateNavVisibility() {
        const nav = document.getElementById('page-controls');
        if(state.chunkSize === 'all') nav.classList.add('hidden'); else nav.classList.remove('hidden');
    }

    function changePage(dir) {
        if(state.chunkSize === 'all') return;
        const next = state.offset + (dir * state.chunkSize);
        if(next >= 1 && next <= state.data.verses.length) { state.offset = next; render(); saveState(); }
    }

    async function loadData() {
        document.getElementById('status').innerText = "Loading data...";
        try {
            const res = await fetch(`data/${state.surah}.json`);
            if(!res.ok) throw new Error("File not found");
            state.data = await res.json();
            document.getElementById('surah-title').innerText = `${state.surah}. ${state.data.name_ar} (${state.data.name_en})`;
            document.getElementById('status').innerText = "Ready";
        } catch(e) { document.getElementById('display').innerHTML = `<div style="color:red;text-align:center">Error: ${e.message}</div>`; }
    }

    function render() {
        if(!state.data) return;
        const div = document.getElementById('display');
        let html = "";
        
        if (state.surah != 1 && state.surah != 9 && state.offset === 1) {
            const bism = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê";
            html += `<div style="text-align:center; margin-bottom:20px; font-size:0.9em; opacity:0.8">${apply(bism, detect(bism))}</div>`;
        }

        let startIdx = state.offset - 1;
        let endIdx = state.chunkSize === 'all' ? state.data.verses.length : Math.min(startIdx + state.chunkSize, state.data.verses.length);
        const chunk = state.data.verses.slice(startIdx, endIdx);

        chunk.forEach((txt, i) => {
            let n = startIdx + i + 1;
            let isSaved = bookmarks.some(b => b.s === state.surah && b.v === n);
            let starClass = isSaved ? 'bm-icon saved' : 'bm-icon';
            
            html += `<div class="verse" id="v${n}" onclick="pick(${n})">
                ${apply(txt, detect(txt))} 
                <span class="num">${n} <span class="${starClass}" onclick="toggleBM(event, ${n})">‚òÖ</span></span>
            </div>`;
        });
        
        div.innerHTML = html;
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if(state.chunkSize !== 'all') document.getElementById('page-info').innerText = `${state.offset}-${endIdx}`;
        document.getElementById('v_start').value = state.offset;
        document.getElementById('v_end').value = endIdx;
    }

    // --- BOOKMARKS ---
    function toggleBM(e, v) {
        e.stopPropagation();
        const existingIdx = bookmarks.findIndex(b => b.s === state.surah && b.v === v);
        if(existingIdx >= 0) bookmarks.splice(existingIdx, 1);
        else bookmarks.push({s: state.surah, v: v, name: state.data.name_en});
        
        localStorage.setItem('warsh_bookmarks', JSON.stringify(bookmarks));
        render(); renderBMList();
    }

    function renderBMList() {
        const div = document.getElementById('bm-list');
        if(bookmarks.length === 0) { div.innerHTML = "No bookmarks yet."; return; }
        div.innerHTML = bookmarks.map((b, i) => `
            <div class="pop-item" onclick="jumpTo(${b.s}, ${b.v})">
                <span>${b.s}. ${b.name} (Ayah ${b.v})</span>
                <span style="color:red" onclick="removeBM(event, ${i})">‚úï</span>
            </div>
        `).join('');
    }

    function removeBM(e, i) {
        e.stopPropagation();
        bookmarks.splice(i, 1);
        localStorage.setItem('warsh_bookmarks', JSON.stringify(bookmarks));
        renderBMList(); render();
    }

    async function jumpTo(s, v) {
        await changeSurah(s, true);
        state.offset = v; // Simple logic: set offset to that verse so it's on the page
        // If paginated, ensure we are on the right page
        if (state.chunkSize !== 'all') {
            const pageStart = Math.floor((v - 1) / state.chunkSize) * state.chunkSize + 1;
            state.offset = pageStart;
        }
        await render();
        setTimeout(() => pick(v), 300);
        togglePanel('bm-panel'); // Close menu
    }

    // --- SEARCH ---
    function runSearch() {
        const q = document.getElementById('search-input').value.trim();
        const resDiv = document.getElementById('search-results');
        if(!q || !state.data) { resDiv.innerHTML = ""; return; }

        let matches = [];
        state.data.verses.forEach((txt, i) => {
            if(txt.includes(q)) matches.push({v: i+1, txt: txt});
        });

        if(matches.length === 0) resDiv.innerHTML = "No matches in this Surah.";
        else {
            resDiv.innerHTML = matches.map(m => `
                <div class="pop-item" onclick="jumpTo(${state.surah}, ${m.v}); togglePanel('search-panel')">
                    <div>
                        <strong>Ayah ${m.v}</strong><br>
                        <span style="color:#666; font-size:0.8em">${m.txt.substring(0, 50)}...</span>
                    </div>
                </div>
            `).join('');
        }
    }

    // --- CORE ---
    function pick(n) { document.getElementById('v_start').value = n; hl(n); }
    function hl(n) { document.querySelectorAll('.active').forEach(e=>e.classList.remove('active')); const el=document.getElementById('v'+n); if(el){el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'});}}

    async function play() {
        if(playing) return; playing=true; stopReq=false;
        
        const btn = document.getElementById('play-btn');
        const reciter = document.getElementById('reciter-select').value;
        const sId = String(state.surah).padStart(3,'0');
        const st = document.getElementById('status');
        
        btn.innerText = "‚è∏ Playing";
        
        while(true) { 
            const start = parseInt(document.getElementById('v_start').value);
            const end = parseInt(document.getElementById('v_end').value);

            for(let a=start; a<=end; a++) {
                if(stopReq) break;
                hl(a); st.innerText = `Playing Ayah ${a} / ${end}`;
                aud.src = `https://everyayah.com/data/${reciter}/${sId}${String(a).padStart(3,'0')}.mp3`;
                
                try {
                    await new Promise((resolve) => {
                        aud.onended = resolve;
                        aud.onerror = () => { console.error('Audio Err'); st.innerText="Err: Missing Audio"; resolve(); }; 
                        aud.play().catch(resolve);
                    });
                } catch(e){}
                if(!stopReq) await new Promise(r=>setTimeout(r, 200)); 
            }
            if(stopReq || !document.getElementById('loop-box').checked) break;
            st.innerText = "Looping...";
            await new Promise(r=>setTimeout(r, 500));
        }
        playing=false; btn.innerText = "‚ñ∂ PLAY"; st.innerText = "Ready";
    }

    function stop() { stopReq=true; aud.pause(); document.getElementById('play-btn').innerText = "‚ñ∂ PLAY"; }
    
    // UI Toggles
    function togglePanel(id) {
        document.querySelectorAll('.popover').forEach(p => {
            if(p.id !== id) p.classList.remove('show');
        });
        document.getElementById(id).classList.toggle('show');
    }
    
    function toggleTheme() { document.body.classList.toggle('dark'); saveState(); }
    function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
    function updateSetting(prop, val) { 
        document.documentElement.style.setProperty('--'+prop, val); 
        saveState();
    }
    
    // START
    init();
    </script>
</body>
</html>
