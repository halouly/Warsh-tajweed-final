<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsh Reader Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#92400e">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- TAJWEED COLORS --- */
        .tj-ghunnah   { color: #16a34a !important; } /* Green */
        .tj-qalqalah  { color: #0284c7 !important; } /* Blue */
        .tj-heavy     { color: #1e3a8a !important; font-weight: bold; } /* Dark Blue */
        .tj-light     { color: #06b6d4 !important; } /* Cyan */
        .tj-special   { color: #d97706 !important; font-weight: bold; } /* Orange */
        .tj-silent    { color: #9ca3af !important; } /* Grey */
        
        /* MADD RULES */
        .tj-mandatory { color: #800020 !important; font-weight: bold; } /* Burgundy (Madd Lazim/Wajib) */
        .tj-madd      { color: #dc2626 !important; } /* Red (Normal/Badal) */

        /* --- THEMES --- */
        :root { 
            --bg: #fffcf2; --text: #1a1a1a; --accent: #92400e; --panel: #ffffff; --border: #e5e5e5;
            --active-bg: #fef3c7; --active-border: #92400e;
            --sz: 32px; --lh: 2.8; --ws: normal; --max-w: 800px;
        }
        body.dark {
            --bg: #1f2937; --text: #f3f4f6; --accent: #fbbf24; --panel: #111827; --border: #374151;
            --active-bg: #374151; --active-border: #fbbf24;
        }

        /* --- LAYOUT --- */
        body { font-family: 'Amiri', serif; background: var(--bg); color: var(--text); margin:0; padding-bottom:180px; transition: 0.3s; }
        
        header {
            position: sticky; top: 0; z-index: 900;
            background: var(--panel); border-bottom: 1px solid var(--border);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { margin:0; font-size: 1.2rem; color: var(--accent); }
        .tools { display: flex; gap: 8px; }
        
        /* PANELS */
        .popover {
            display: none; position: absolute; top: 60px; right: 20px;
            background: var(--panel); border: 1px solid var(--border); 
            padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 950; min-width: 300px; max-height: 500px; overflow-y: auto;
        }
        .popover.show { display: block; }
        html[dir="rtl"] .popover { right: auto; left: 20px; }
        .pop-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .pop-item:hover { background: rgba(0,0,0,0.05); }
        .typo-row { margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .typo-label { font-size: 0.8rem; opacity: 0.8; }

        /* CONTENT */
        #display { padding: 40px 20px; max-width: var(--max-w); margin: 0 auto; line-height: var(--lh); word-spacing: var(--ws); text-align: justify; }
        .verse { display: inline; font-size: var(--sz); cursor: pointer; padding: 4px 0; border-bottom: 1px dashed var(--border); transition: 0.2s; position: relative; }
        .verse:hover { background: rgba(0,0,0,0.05); }
        .verse.active { background: var(--active-bg); box-shadow: 0 0 0 3px var(--active-bg); border-radius: 6px; color: var(--text) !important; }
        .num { font-size: 0.5em; color: var(--accent); border: 1px solid var(--accent); border-radius: 50%; padding: 0 6px; margin: 0 6px; vertical-align: middle; user-select: none; display: inline-block; }
        .bm-icon { font-size: 0.6em; margin-left: 5px; color: #ccc; cursor: pointer; transition: 0.2s; }
        .bm-icon:hover, .bm-icon.saved { color: #f59e0b; }

        /* CONTROLS */
        #controls { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel); border-top: 2px solid var(--accent); padding: 15px; z-index: 1000; direction: ltr; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); }
        .row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        select, input, button { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 14px; outline: none; }
        button { cursor: pointer; font-weight: bold; background: var(--bg); }
        button:hover { background: var(--border); }
        button.primary { background: var(--accent); color: #fff; border: none; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; color: var(--text); }
        input[type=range] { accent-color: var(--accent); cursor: pointer; width: 100%; }
        #status { text-align: center; font-size: 0.8rem; opacity: 0.7; margin-top: 5px; }
        .big-btn { font-size: 1.5rem; padding: 0 15px; line-height: 1; }
        .page-nav { display: flex; gap: 5px; align-items: center; }
        .page-nav.hidden { display: none; }
        #custom-chunk-input { width: 50px; display: none; text-align: center; }
        #custom-chunk-input.show { display: inline-block; }
    </style>
</head>
<body>
    <header>
        <div class="tools">
            <button class="icon-btn" onclick="togglePanel('search-panel')" title="Search">üîç</button>
            <button class="icon-btn" onclick="togglePanel('bm-panel')" title="Bookmarks">‚òÖ</button>
            <button class="icon-btn" onclick="togglePanel('typo-panel')" title="Text Settings">T</button>
            <button class="icon-btn" onclick="toggleTheme()" title="Theme">üåó</button>
            <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">‚õ∂</button>
        </div>
        <h1 id="surah-title">Warsh Reader</h1>
    </header>

    <div id="search-panel" class="popover">
        <h3 style="margin-top:0">Search</h3>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="search-input" placeholder="Type word..." style="flex:1">
            <button onclick="runGlobalSearch()">Go</button>
        </div>
        <div id="search-status" style="font-size:0.8rem; color:#666; margin-bottom:5px;"></div>
        <div id="search-results" style="max-height:300px; overflow-y:auto;"></div>
    </div>
    <div id="bm-panel" class="popover"><h3 style="margin-top:0">Bookmarks</h3><div id="bm-list">No bookmarks yet.</div></div>
    <div id="typo-panel" class="popover">
        <div class="typo-row"><span class="typo-label">Text Size</span><input type="range" min="20" max="70" value="32" oninput="updateSetting('sz', this.value+'px')"></div>
        <div class="typo-row"><span class="typo-label">Line Height</span><input type="range" min="1.5" max="4.0" step="0.1" value="2.8" oninput="updateSetting('lh', this.value)"></div>
        <div class="typo-row"><span class="typo-label">Word Spacing</span><input type="range" min="0" max="20" value="0" oninput="updateSetting('ws', this.value+'px')"></div>
        <div class="typo-row"><span class="typo-label">Content Width</span><input type="range" min="400" max="1200" value="800" oninput="updateSetting('max-w', this.value+'px')"></div>
    </div>

    <div id="display">Select a Surah...</div>

    <div id="controls">
        <div class="row">
            <button onclick="navSurah(-1)">¬´</button>
            <select id="surah-select" onchange="changeSurah(this.value)" style="width:160px"></select>
            <button onclick="navSurah(1)">¬ª</button>
            <span style="opacity:0.5; margin:0 5px;">|</span>
            <div style="display:flex; align-items:center; gap:5px;">
                <select id="view-mode" onchange="changeViewMode(this.value)" style="width:100px">
                    <option value="all">All</option>
                    <option value="5">5 Verses</option>
                    <option value="10">10 Verses</option>
                    <option value="custom">Custom...</option>
                </select>
                <input type="number" id="custom-chunk-input" min="1" max="286" placeholder="#" onchange="setCustomChunk(this.value)">
            </div>
            <div id="page-controls" class="page-nav hidden">
                <button class="big-btn" onclick="changePage(-1)">‚Äπ</button>
                <span id="page-info" style="font-size:0.9rem; min-width:60px; text-align:center">1-5</span>
                <button class="big-btn" onclick="changePage(1)">‚Ä∫</button>
            </div>
        </div>
        <div class="row">
            <select id="reciter-select" style="width:160px" onchange="saveState()">
                <option value="warsh/warsh_ibrahim_aldosary_128kbps">Ibrahim Al-Dosary</option>
                <option value="warsh/warsh_yassin_al_jazaery_64kbps">Yassin Al-Jazaery</option>
                <option value="warsh/warsh_Abdul_Basit_128kbps">Abdul Basit (Warsh)</option>
            </select>
            <div style="width:1px; height:20px; background:var(--border)"></div>
            <div style="display:flex; align-items:center; gap:5px; font-size:0.9rem;">
                <span>Ayah:</span><input type="number" id="v_start" value="1" min="1" style="width:50px">
                <span>to</span><input type="number" id="v_end" value="1" min="1" style="width:50px">
            </div>
            <label style="display:flex; align-items:center; gap:5px; font-size:0.8rem; cursor:pointer"><input type="checkbox" id="loop-box"> Loop</label>
            <button class="primary" onclick="play()" id="play-btn">‚ñ∂ PLAY</button>
            <button onclick="stop()">‚èπ</button>
        </div>
        <div id="status">Ready</div>
    </div>

    <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    const SURAH_NAMES = ["Al-Fatiha","Al-Baqarah","Al-Imran","An-Nisa","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Tawbah","Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra","Al-Kahf","Maryam","Ta-Ha","Al-Anbiya","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara","An-Naml","Al-Qasas","Al-Ankabut","Ar-Rum","Luqman","As-Sajdah","Al-Ahzab","Saba","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Adh-Dhariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadila","Al-Hashr","Al-Mumtahanah","As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzzammil","Al-Muddathir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba","An-Nazi'at","Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","Ad-Duhaa","Ash-Sharh","At-Tin","Al-Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-Adiyat","Al-Qari'ah","At-Takathur","Al-Asr","Al-Humazah","Al-Fil","Quraysh","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr","Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"];

    // --- REFINED TAJWEED ENGINE ---
    const SUKUN='\u0652', SHADDA='\u0651', FATHA='\u064E', DAMMA='\u064F', KASRA='\u0650';
    const DAGGER='\u0670', MADD_SIGN='\u0653', WARSH_DOT='\u06EC'; 
    const QALQ='ŸÇÿ∑ÿ®ÿ¨ÿØ', IDGH_GH='ŸäŸÜŸÖŸà', IDGH_NO='ŸÑÿ±', IKHFA='ÿ™ÿ´ÿ¨ÿØÿ∞ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ŸÅŸÇŸÉ';
    const MADD='ÿßŸàŸâ'+DAGGER, HAMZA='ÿ°ÿ£ÿ•ÿ§ÿ¶', HEAVY_LAM_TRIGGERS = 'ÿµÿ∑ÿ∏'; 

    function isDiac(c){const x=c.charCodeAt(0); return (x>=0x064B && x<=0x065F) || x===0x0670 || (x>=0x06D6 && x<=0x06ED);}
    function isLtr(c){const x=c.charCodeAt(0); return !isDiac(c) && x>=0x0600 && x<=0x06FF;}
    function getDiac(t,i){let d=[]; for(let j=i+1;j<t.length&&isDiac(t[j]);j++)d.push(t[j]); return d;}
    function has(t,i,c){return getDiac(t,i).includes(c);}
    function getEnd(t, i){let j=i+1; while(j<t.length&&isDiac(t[j]))j++; return j;}
    function nextL(t,i){for(let j=i+1;j<t.length;j++)if(isLtr(t[j]))return{c:t[j],i:j}; return null;}
    function prevL(t,i){for(let j=i-1;j>=0;j--)if(isLtr(t[j]))return{c:t[j],i:j}; return null;}

    function detect(t){
        const a=[];
        for(let i=0;i<t.length;i++){
            const c=t[i]; if(!isLtr(c)) continue;
            const n=nextL(t,i), p=prevL(t,i), rangeEnd=getEnd(t, i);
            const diacs=getDiac(t,i);
            const isSakin=has(t,i,SUKUN) || (!diacs.length && n && !has(t,i,SHADDA)); 
            const hasVowel=has(t,i,FATHA) || has(t,i,DAMMA) || has(t,i,KASRA);
            const isShadda=has(t,i,SHADDA);
            let rule=null;

            if (has(t, i, WARSH_DOT) || has(t, i, '\u065F')) rule='tj-special';
            else if((c==='ŸÜ'||c==='ŸÖ') && isShadda) rule='tj-ghunnah';
            else if(c==='ŸÜ' && isSakin && n){
                if(IDGH_GH.includes(n.c) || n.c==='ÿ®' || IKHFA.includes(n.c)) rule='tj-ghunnah';
                else if(IDGH_NO.includes(n.c)) rule='tj-silent';
            }
            else if(c==='ŸÖ' && isSakin && n && n.c==='ÿ®') rule='tj-ghunnah';
            else if(QALQ.includes(c) && (has(t,i,SUKUN) || (!hasVowel && !n))) rule='tj-qalqalah';
            else if(c==='ŸÑ' && has(t,i,FATHA) && p && HEAVY_LAM_TRIGGERS.includes(p.c) && (has(t,p.i,FATHA)||has(t,p.i,SUKUN)||!getDiac(t,p.i).length)) rule='tj-heavy';
            else if(c==='ÿ±'){
                if(has(t,i,FATHA) || has(t,i,DAMMA)) rule='tj-heavy';
                if(has(t,i,KASRA)) rule='tj-light'; 
                else if((has(t,i,FATHA) || has(t,i,DAMMA)) && p){
                    if(has(t,p.i,KASRA) || (p.c==='Ÿä' && (has(t,p.i,SUKUN)||!getDiac(t,p.i).length))) rule='tj-light';
                }
            }
            // --- STRICT MADD LOGIC ---
            else if(MADD.includes(c) && !hasVowel && !isShadda){
                // Mandatory (Burgundy)
                if(has(t,i,MADD_SIGN)) rule='tj-mandatory'; 
                else if(n && (has(t,n.i,SHADDA) || has(t,n.i,SUKUN))) rule='tj-mandatory';
                else if(n && HAMZA.includes(n.c)) rule='tj-mandatory'; 
                // Badal (Red)
                else if(!rule && p && HAMZA.includes(p.c)) rule='tj-madd';
            }
            else if(c==='ŸÑ' && isSakin && n && has(t,n.i,SHADDA)) rule='tj-silent';
            if(rule) a.push({s:i, e:rangeEnd, cls:rule});
        }
        return a;
    }

    // --- UPDATED APPLY WITH ZWJ LIGATURE FIX ---
    function apply(t, ann){
        // Characters that NEVER connect to the Left (Forward)
        const NO_LEFT_JOIN = "ÿßÿ£ÿ•ÿ¢Ÿ±ÿØÿ∞ÿ±ÿ≤Ÿàÿ§ÿ©Ÿâ"; 
        
        const m = new Map(); 
        for(const x of ann) for(let i=x.s; i<x.e; i++) m.set(i, x);
        
        let h = '', cls = null;
        
        for(let i=0; i<t.length; i++){
            const x = m.get(i);
            const nc = x ? x.cls : null;
            const c = t[i];
            
            // Look around to determine connectivity
            const prevC = (i > 0) ? t[i-1] : null;
            const nextC = (i < t.length-1) ? t[i+1] : null;

            let prefix = ""; 
            let suffix = "";
            
            // If we are coloring this letter, check if it SHOULD connect
            if(nc) {
                // Connect to Previous? (If previous allows left-joining, and isn't a space)
                if(prevC && !NO_LEFT_JOIN.includes(prevC) && prevC !== ' ' && !isDiac(prevC)) prefix = "&zwj;";
                
                // Connect to Next? (If current allows left-joining, and next isn't a space)
                if(!NO_LEFT_JOIN.includes(c) && nextC && nextC !== ' ' && !isDiac(nextC)) suffix = "&zwj;";
            }

            if(nc !== cls){ 
                if(cls) h += '</span>'; 
                if(nc) h += `<span class="${nc}">`; 
                cls = nc; 
            }
            
            // Inject invisible joiners inside the span
            h += prefix + c + suffi
