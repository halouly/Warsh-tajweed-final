<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsh Reader Pro (Standalone)</title>
    <style>
        /* --- TAJWEED COLORS (FIXED) --- */
        .tj-ghunnah   { color: #16a34a !important; } 
        .tj-qalqalah  { color: #0284c7 !important; } 
        .tj-heavy     { color: #1e3a8a !important; font-weight: bold; }
        .tj-light     { color: #06b6d4 !important; }
        .tj-special   { color: #d97706 !important; font-weight: bold; } 
        .tj-silent    { color: #9ca3af !important; }
        .tj-mandatory { color: #800020 !important; font-weight: bold; }
        .tj-madd      { color: #dc2626 !important; }

        /* --- UI STYLES --- */
        :root { --bg: #fffcf2; --text: #1a1a1a; --accent: #92400e; --panel: #ffffff; --border: #e5e5e5; --active-bg: #fef3c7; --sz: 32px; --lh: 2.8; --ws: normal; --max-w: 800px; }
        body.dark { --bg: #1f2937; --text: #f3f4f6; --accent: #fbbf24; --panel: #111827; --border: #374151; --active-bg: #374151; }
        body { font-family: 'Amiri', serif; background: var(--bg); color: var(--text); margin:0; padding-bottom:180px; }
        header { position: sticky; top: 0; z-index: 900; background: var(--panel); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin:0; font-size: 1.2rem; color: var(--accent); }
        #display { padding: 40px 20px; max-width: var(--max-w); margin: 0 auto; line-height: var(--lh); word-spacing: var(--ws); text-align: justify; }
        .verse { display: inline; font-size: var(--sz); cursor: pointer; padding: 4px 0; border-bottom: 1px dashed var(--border); }
        .verse.active { background: var(--active-bg); box-shadow: 0 0 0 3px var(--active-bg); border-radius: 6px; }
        .num { font-size: 0.5em; color: var(--accent); border: 1px solid var(--accent); border-radius: 50%; padding: 0 6px; margin: 0 6px; display: inline-block; }
        #controls { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel); border-top: 2px solid var(--accent); padding: 15px; z-index: 1000; direction: ltr; }
        .row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        select, input, button { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        button.primary { background: var(--accent); color: #fff; border: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1>Warsh Reader</h1>
        <button onclick="document.body.classList.toggle('dark')">üåó</button>
    </header>

    <div id="display">Select a Surah...</div>

    <div id="controls">
        <div class="row">
            <select id="surah-select" onchange="loadSurah(this.value)">
                 <option value="1">1. Al-Fatiha</option>
                 <option value="2">2. Al-Baqarah (Demo)</option>
            </select>
        </div>
        <div class="row">
            <select id="reciter-select">
                <option value="warsh/warsh_ibrahim_aldosary_128kbps">Ibrahim Al-Dosary</option>
                <option value="warsh/warsh_yassin_al_jazaery_64kbps">Yassin Al-Jazaery</option>
                <option value="warsh/warsh_Abdul_Basit_128kbps">Abdul Basit</option>
            </select>
            <button class="primary" onclick="play()">‚ñ∂ PLAY</button>
            <button onclick="stop()">‚èπ</button>
        </div>
        <div id="status" style="text-align:center; font-size:0.8rem; color:#666">Ready</div>
    </div>

    <script>
    // --- 1. EMBEDDED DATA (NO FETCH NEEDED) ---
    const QURAN_DATA = {
        "1": {
            "name": "Al-Fatiha",
            "verses": [
                "Ÿ±ŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸëŸéŸáŸê ÿ±Ÿéÿ®ŸëŸê Ÿ±ŸÑŸíÿπŸéŸÄŸ∞ŸÑŸéŸÖŸêŸäŸÜŸé",
                "Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê",
                "ŸÖŸéŸÄŸ∞ŸÑŸêŸÉŸê ŸäŸéŸàŸíŸÖŸê Ÿ±ŸÑÿØŸëŸêŸäŸÜŸê",
                "ÿ•ŸêŸäŸëŸéÿßŸÉŸé ŸÜŸéÿπŸíÿ®ŸèÿØŸè ŸàŸéÿ•ŸêŸäŸëŸéÿßŸÉŸé ŸÜŸéÿ≥Ÿíÿ™ŸéÿπŸêŸäŸÜŸè",
                "Ÿ±ŸáŸíÿØŸêŸÜŸéÿß Ÿ±ŸÑÿµŸëŸêÿ±ŸéŸ∞ÿ∑Ÿé Ÿ±ŸÑŸíŸÖŸèÿ≥Ÿíÿ™ŸéŸÇŸêŸäŸÖŸé",
                "ÿµŸêÿ±ŸéŸ∞ÿ∑Ÿé Ÿ±ŸÑŸëŸéÿ∞ŸêŸäŸÜŸé ÿ£ŸéŸÜŸíÿπŸéŸÖŸíÿ™Ÿé ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ÿ∫ŸéŸäŸíÿ±Ÿê Ÿ±ŸÑŸíŸÖŸéÿ∫Ÿíÿ∂ŸèŸàÿ®Ÿê ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ŸàŸéŸÑŸéÿß Ÿ±ŸÑÿ∂ŸëŸéÿßŸÑŸëŸêŸäŸÜŸé"
            ]
        },
        "2": {
            "name": "Al-Baqarah (Demo)",
            "verses": [
                "ÿßŸÑŸìŸÖŸì",
                "ÿ∞ŸéŸ∞ŸÑŸêŸÉŸé Ÿ±ŸÑŸíŸÉŸêÿ™ŸéŸÄŸ∞ÿ®Ÿè ŸÑŸéÿß ÿ±ŸéŸäŸíÿ®Ÿé €õ ŸÅŸêŸäŸáŸê €õ ŸáŸèÿØŸãŸâ ŸÑŸëŸêŸÑŸíŸÖŸèÿ™ŸëŸéŸÇŸêŸäŸÜŸé",
                "Ÿ±ŸÑŸëŸéÿ∞ŸêŸäŸÜŸé ŸäŸèÿ§ŸíŸÖŸêŸÜŸèŸàŸÜŸé ÿ®ŸêŸ±ŸÑŸíÿ∫ŸéŸäŸíÿ®Ÿê ŸàŸéŸäŸèŸÇŸêŸäŸÖŸèŸàŸÜŸé Ÿ±ŸÑÿµŸëŸéŸÑŸéŸàŸ∞ÿ©Ÿé ŸàŸéŸÖŸêŸÖŸëŸéÿß ÿ±Ÿéÿ≤ŸéŸÇŸíŸÜŸéŸÄŸ∞ŸáŸèŸÖŸí ŸäŸèŸÜŸÅŸêŸÇŸèŸàŸÜŸé",
                "ŸàŸéŸ±ŸÑŸëŸéÿ∞ŸêŸäŸÜŸé ŸäŸèÿ§ŸíŸÖŸêŸÜŸèŸàŸÜŸé ÿ®ŸêŸÖŸéÿßŸì ÿ£ŸèŸÜÿ≤ŸêŸÑŸé ÿ•ŸêŸÑŸéŸäŸíŸÉŸé ŸàŸéŸÖŸéÿßŸì ÿ£ŸèŸÜÿ≤ŸêŸÑŸé ŸÖŸêŸÜ ŸÇŸéÿ®ŸíŸÑŸêŸÉŸé ŸàŸéÿ®ŸêŸ±ŸÑŸíŸÄŸîŸéÿßÿÆŸêÿ±Ÿéÿ©Ÿê ŸáŸèŸÖŸí ŸäŸèŸàŸÇŸêŸÜŸèŸàŸÜŸé",
                "ÿ£ŸèŸà€üŸÑŸéŸÄŸ∞Ÿìÿ¶ŸêŸÉŸé ÿπŸéŸÑŸéŸâŸ∞ ŸáŸèÿØŸãŸâ ŸÖŸëŸêŸÜ ÿ±ŸëŸéÿ®ŸëŸêŸáŸêŸÖŸí €ñ ŸàŸéÿ£ŸèŸà€üŸÑŸéŸÄŸ∞Ÿìÿ¶ŸêŸÉŸé ŸáŸèŸÖŸè Ÿ±ŸÑŸíŸÖŸèŸÅŸíŸÑŸêÿ≠ŸèŸàŸÜŸé"
            ]
        }
    };

    // --- 2. TAJWEED RULES (FIXED & RESTORED) ---
    const SUKUN='\u0652', SHADDA='\u0651', FATHA='\u064E', DAMMA='\u064F', KASRA='\u0650';
    const DAGGER='\u0670', MADD_SIGN='\u0653', WARSH_DOT='\u06EC'; 
    const QALQ='ŸÇÿ∑ÿ®ÿ¨ÿØ', IDGH_GH='ŸäŸÜŸÖŸà', IDGH_NO='ŸÑÿ±', IKHFA='ÿ™ÿ´ÿ¨ÿØÿ∞ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ŸÅŸÇŸÉ';
    const MADD='ÿßŸàŸâ'+DAGGER+'\u06E5'+'\u06E6'+'\u0622', HAMZA='ÿ°ÿ£ÿ•ÿ§ÿ¶'; 
    const HEAVY_LAM_TRIGGERS = 'ÿµÿ∑ÿ∏'; 

    function isDiac(c){const x=c.charCodeAt(0); return (x>=0x064B && x<=0x065F) || x===0x0670 || (x>=0x06D6 && x<=0x06ED && x!==0x06E5 && x!==0x06E6);}
    function isLtr(c){const x=c.charCodeAt(0); return !isDiac(c) && x>=0x0600 && x<=0x06FF;}
    function getDiac(t,i){let d=[]; for(let j=i+1;j<t.length&&isDiac(t[j]);j++)d.push(t[j]); return d;}
    function has(t,i,c){return getDiac(t,i).includes(c);}
    function getEnd(t, i){let j=i+1; while(j<t.length&&isDiac(t[j]))j++; return j;}
    function nextL(t,i){for(let j=i+1;j<t.length;j++)if(isLtr(t[j]))return{c:t[j],i:j}; return null;}
    function prevL(t,i){for(let j=i-1;j>=0;j--)if(isLtr(t[j]))return{c:t[j],i:j}; return null;}

    function detect(t){
        const a=[];
        for(let i=0;i<t.length;i++){
            const c=t[i]; if(!isLtr(c)) continue;
            const n=nextL(t,i), p=prevL(t,i), rangeEnd=getEnd(t, i);
            const diacs=getDiac(t,i);
            const isSakin=has(t,i,SUKUN) || (!diacs.length && n && !has(t,i,SHADDA)); 
            const hasVowel=has(t,i,FATHA) || has(t,i,DAMMA) || has(t,i,KASRA);
            const isShadda=has(t,i,SHADDA);
            let rule=null;

            if (has(t, i, MADD_SIGN)) rule = 'tj-mandatory'; 
            else if (has(t, i, WARSH_DOT) || has(t, i, '\u065F')) rule='tj-special';
            else if((c==='ŸÜ'||c==='ŸÖ') && isShadda) rule='tj-ghunnah';
            else if(c==='ŸÜ' && isSakin && n){
                if(IDGH_GH.includes(n.c) || n.c==='ÿ®' || IKHFA.includes(n.c)) rule='tj-ghunnah';
                else if(IDGH_NO.includes(n.c)) rule='tj-silent';
            }
            else if(c==='ŸÖ' && isSakin && n && n.c==='ÿ®') rule='tj-ghunnah';
            else if(QALQ.includes(c) && (has(t,i,SUKUN) || (!hasVowel && !n))) rule='tj-qalqalah';
            else if(c==='ŸÑ' && has(t,i,FATHA) && p && HEAVY_LAM_TRIGGERS.includes(p.c) && (has(t,p.i,FATHA)||has(t,p.i,SUKUN)||!getDiac(t,p.i).length)) rule='tj-heavy';
            else if(c==='ÿ±'){
                if(has(t,i,FATHA) || has(t,i,DAMMA)) rule='tj-heavy';
                if(has(t,i,KASRA)) rule='tj-light'; 
                else if((has(t,i,FATHA) || has(t,i,DAMMA)) && p){
                    if(has(t,p.i,KASRA) || (p.c==='Ÿä' && (has(t,p.i,SUKUN)||!getDiac(t,p.i).length))) rule='tj-light';
                }
            }
            else if(MADD.includes(c) && !isShadda && (!hasVowel || c === '\u0622')){
                // JAWAZ RULE (Corrected): Check if next letter is the LAST letter
                const nn = n ? nextL(t, n.i) : null;
                if (n && !nn && !has(t, n.i, SHADDA)) rule = 'tj-special'; 
                else if (c === '\u0622') rule='tj-madd';
                else if(n && HAMZA.includes(n.c)) rule='tj-mandatory';
                else if(n && (has(t,n.i,SHADDA) || has(t,n.i,SUKUN))) {
                    if (n.c !== 'ÿß') rule='tj-mandatory';
                }
                else if(!rule && p && HAMZA.includes(p.c)) rule='tj-madd';
            }
            else if(c==='ŸÑ' && isSakin && n && has(t,n.i,SHADDA)) rule='tj-silent';
            if(rule) a.push({s:i, e:rangeEnd, cls:rule});
        }
        return a;
    }

    function apply(t, ann){
        const NO_LEFT_JOIN = "ÿßÿ£ÿ•ÿ¢Ÿ±ÿØÿ∞ÿ±ÿ≤Ÿàÿ§ÿ©Ÿâ"; 
        const m = new Map(); for(const x of ann) for(let i=x.s; i<x.e; i++) m.set(i, x);
        let h = '', cls = null;
        for(let i=0; i<t.length; i++){
            const x = m.get(i);
            const nc = x ? x.cls : null;
            const c = t[i];
            const prevC = (i > 0) ? t[i-1] : null;
            const nextC = (i < t.length-1) ? t[i+1] : null;
            let prefix = "", suffix = "";
            if(nc) {
                if(prevC && !NO_LEFT_JOIN.includes(prevC) && prevC !== ' ' && !isDiac(prevC)) prefix = "&zwj;";
                if(!NO_LEFT_JOIN.includes(c) && nextC && nextC !== ' ' && !isDiac(nextC)) suffix = "&zwj;";
            }
            if(nc !== cls){ if(cls) h += '</span>'; if(nc) h += `<span class="${nc}">`; cls = nc; }
            h += prefix + c + suffix;
        }
        if(cls) h += '</span>'; 
        return h;
    }

    // --- 3. APP LOGIC ---
    let currentSurah = 1;
    let playing = false;
    let stopReq = false;
    const aud = new Audio();

    function loadSurah(id) {
        currentSurah = id;
        const div = document.getElementById('display');
        const data = QURAN_DATA[id];
        
        if (!data) {
            div.innerHTML = "<br><b>FULL QURAN DATA NOT INCLUDED IN THIS DEMO FILE.</b><br>To get the full Quran, we must switch back to the GitHub version.";
            return;
        }

        let html = "";
        if(id != 1 && id != 9) {
             const bism = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê";
             html += `<div style="text-align:center; margin-bottom:20px; font-size:0.9em; opacity:0.8">${apply(bism, detect(bism))}</div>`;
        }

        data.verses.forEach((txt, i) => {
            let n = i + 1;
            html += `<div class="verse" id="v${n}" onclick="playAyah(${n})">${apply(txt, detect(txt))} <span class="num">${n}</span></div>`;
        });
        div.innerHTML = html;
        document.getElementById('surah-title').innerText = data.name;
    }

    async function play() {
        if(playing) return;
        playing = true;
        stopReq = false;
        const reciter = document.getElementById('reciter-select').value;
        const data = QURAN_DATA[currentSurah];
        const sId = String(currentSurah).padStart(3, '0');

        for(let i=0; i<data.verses.length; i++) {
            if(stopReq) break;
            const n = i + 1;
            highlight(n);
            document.getElementById('status').innerText = `Playing Ayah ${n}...`;
            
            aud.src = `https://everyayah.com/data/${reciter}/${sId}${String(n).padStart(3, '0')}.mp3`;
            
            try {
                await new Promise((resolve) => {
                    aud.onended = resolve;
                    aud.onerror = () => { console.log('Error'); resolve(); };
                    aud.play().catch(e => { console.log(e); resolve(); });
                });
            } catch(e){}
        }
        playing = false;
        document.getElementById('status').innerText = "Ready";
    }

    function stop() { stopReq = true; aud.pause(); playing = false; }
    function highlight(n) { document.querySelectorAll('.active').forEach(e=>e.classList.remove('active')); const el=document.getElementById('v'+n); if(el){el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'});}}
    function playAyah(n) { alert("Play button starts from beginning in this demo."); }

    // Init
    loadSurah(1);
    </script>
</body>
</html>
